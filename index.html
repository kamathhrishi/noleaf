<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y90Q1DKJCC"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-Y90Q1DKJCC');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>NoLeaf | Explore Finance, AI & Cybersecurity Events (USA)</title>
    <meta name="description" content="Find Finance, AI, and Cybersecurity events near you or filter by city/state. Explore conferences, seminars, and networking events across the United States curated by NoLeaf.">
    <link rel="canonical" href="https://noleaf.app/event-finder/" />

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://noleaf.app/event-finder/">
    <meta property="og:title" content="NoLeaf | Nearby & Filterable Finance, AI & Cybersecurity Events (USA)">
    <meta property="og:description" content="Find Finance, AI, and Cybersecurity events near you or filter by city/state. Explore conferences, seminars, and networking events across the United States curated by NoLeaf.">
    <meta property="og:image" content="https://noleaf.app/images/noleaf-social-preview.jpg"> <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://noleaf.app/event-finder/">
    <meta property="twitter:title" content="NoLeaf | Nearby & Filterable Finance, AI & Cybersecurity Events (USA)">
    <meta property="twitter:description" content="Find Finance, AI, and Cybersecurity events near you or filter by city/state. Explore conferences, seminars, and networking events across the United States curated by NoLeaf.">
    <meta property="twitter:image" content="https://noleaf.app/images/noleaf-social-preview.jpg"> <script type="application/ld+json" id="website-schema">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "NoLeaf Event Finder",
      "url": "https://noleaf.app/",
      "description": "Find Finance, AI, and Cybersecurity events near you or filter by city/state across the United States.",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://noleaf.app/",
        "query-input": "required name=search_term_string"
      }
    }
    </script>
    <script type="application/ld+json" id="event-schema-placeholder"></script>


    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* Apply body theme classes (will be added/removed by JS) */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease; /* Smooth theme transition */
            background-color: #f3f4f6; /* Default background */
            -webkit-font-smoothing: antialiased; /* Improve font rendering */
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Custom Styles --- */

        /* Card Enhancements */
        .event-card {
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05); /* shadow-md equivalent */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%; /* Ensure cards in a row take same height */
        }
        .event-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); /* shadow-lg equivalent */
            transform: translateY(-5px) scale(1.01);
        }
        .event-card-content {
            padding: 1.5rem; /* p-6 */
            flex-grow: 1; /* Allow content to grow */
            display: flex;
            flex-direction: column;
        }
         .event-card-footer {
             margin-top: auto; /* Push footer to bottom */
             padding-top: 1rem; /* pt-4 */
         }

        /* Date Badge */
        .date-badge {
            position: absolute;
            top: 1rem; /* top-4 */
            left: -0.5rem; /* -left-2 */
            /* Background set by theme */
            color: white;
            padding: 0.5rem 0.75rem 0.5rem 1rem; /* py-2 pr-3 pl-4 */
            border-radius: 0 0.5rem 0.5rem 0; /* rounded-r-lg */
            font-weight: 600; /* font-semibold */
            font-size: 0.875rem; /* text-sm */
            /* Box shadow set by theme */
            display: flex;
            align-items: center;
            gap: 0.25rem; /* gap-1 */
            z-index: 10; /* Ensure badge is above content */
        }
        .date-badge .day { font-size: 1.125rem; font-weight: 700; line-height: 1; } /* text-lg font-bold leading-none */
        .date-badge .month { font-size: 0.75rem; line-height: 1; text-transform: uppercase; } /* text-xs leading-none uppercase */

        /* Location Badge */
        .location-badge {
            display: inline-flex;
            align-items: center;
            border-radius: 9999px; /* rounded-full */
            padding: 0.25rem 0.75rem; /* px-3 py-1 */
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* font-semibold */
            letter-spacing: 0.025em; /* tracking-wide */
        }
        /* Specific City Badges */
        .nyc-badge { background-color: rgba(59, 130, 246, 0.1); color: #1d4ed8; border: 1px solid rgba(59, 130, 246, 0.3); } /* Blue */
        .philly-badge { background-color: rgba(16, 185, 129, 0.1); color: #047857; border: 1px solid rgba(16, 185, 129, 0.3); } /* Emerald */
        /* Generic Badge (used for tech hubs for now, can be customized) */
        .generic-badge { background-color: #e5e7eb; color: #374151; border: 1px solid #d1d5db; } /* Gray */


        /* Header Gradient & Accent (Set by theme) */
        .gradient-bg { transition: background 0.3s ease; }
        .gradient-accent { transition: background 0.3s ease, opacity 0.2s ease-in-out; }
        .gradient-accent:hover { opacity: 0.9; }

        /* Logo Text & Gradient (Set by theme) */
        .logo-text { font-weight: 800; letter-spacing: -0.025em; } /* font-extrabold tracking-tight */
        .text-gradient { transition: background 0.3s ease; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* Headline Styling for Responsiveness */
        .headline-logo {
            font-size: 3.75rem; /* text-6xl - Base size for mobile */
            line-height: 1;
            display: block;
            margin-bottom: 0.5rem; /* mb-2 */
        }
        .headline-description {
            font-size: 1.25rem; /* text-xl - Base size for mobile */
            line-height: 1.75rem; /* leading-7 */
            font-weight: 600; /* semibold */
            display: block;
            color: #d1d5db; /* Lighter text color (gray-400) */
        }
        /* Responsive adjustments */
        @media (min-width: 640px) { /* sm breakpoint */
            .headline-logo {
                font-size: 4.5rem; /* text-7xl */
                margin-bottom: 0.75rem; /* mb-3 */
            }
             .headline-description {
                font-size: 1.5rem; /* text-2xl */
                line-height: 2rem; /* leading-8 */
            }
        }
        @media (min-width: 1024px) { /* lg breakpoint */
            .headline-logo {
                font-size: 6rem; /* text-9xl */
                margin-bottom: 1rem; /* mb-4 */
            }
            .headline-description {
                font-size: 1.875rem; /* text-3xl */
                line-height: 2.25rem; /* leading-9 */
            }
        }


        /* Loading Animation */
        .loading-animate { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        #loading { display: none; }
        #loading i { transition: color 0.3s ease; } /* Loading spinner color set by theme */

        /* Line Clamp */
        .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }
        .line-clamp-3 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 3; }

        /* Custom Date Input Styling - REFINED for Mobile */
        input[type="date"] { appearance: none; -webkit-appearance: none; position: relative; background-color: white; }
        input[type="date"].custom-date-input {
            border: 1px solid #d1d5db; border-radius: 0.375rem;
            /* Adjusted padding for mobile */
            padding: 0.375rem 0.625rem; /* py-1.5 px-2.5 */
            font-size: 0.875rem; line-height: 1.25rem; color: #374151; /* text-sm text-gray-700 */
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            height: 2.25rem; /* Fixed height to match buttons/select */
            box-sizing: border-box;
        }
        /* Larger padding for larger screens */
        @media (min-width: 640px) {
             input[type="date"].custom-date-input {
                 padding: 0.5rem 0.75rem; /* py-2 px-3 */
             }
        }
        input[type="date"].custom-date-input:focus {
            outline: none; border-color: #4f46e5; /* Default focus color, can be themed if desired */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3); /* Default focus shadow */
        }

        input[type="date"].custom-date-input::-webkit-calendar-picker-indicator {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="%236b7280" style="width:1rem; height:1rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" /></svg>') no-repeat center;
            background-size: 1rem 1rem; cursor: pointer; opacity: 0.7; transition: opacity 0.2s ease;
            /* Adjust position slightly if needed */
            position: absolute;
            right: 0.5rem; /* Adjust as needed */
            top: 50%;
            transform: translateY(-50%);
        }
         input[type="date"].custom-date-input::-webkit-calendar-picker-indicator:hover { opacity: 1; }

        /* Custom Select Dropdown Styling - REFINED for Mobile */
        select.custom-select-input {
            appearance: none; -webkit-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="%236b7280" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 8l4 4 4-4"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em 1em; /* Adjusted size */
            padding-right: 2rem; /* Make space for the arrow */
            border: 1px solid #d1d5db; border-radius: 0.375rem; /* border-gray-300 rounded-md */
            /* REFINED Padding */
            padding-top: 0.375rem; padding-bottom: 0.375rem; padding-left: 0.625rem; /* py-1.5 pl-2.5 */
            font-size: 0.875rem; line-height: 1.25rem; color: #374151; /* text-sm text-gray-700 */
            background-color: white;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
             /* REFINED Limit width */
             width: auto; /* Allow shrinking */
             max-width: 150px; /* Further Reduced max width */
             height: 2.25rem; /* Fixed height to match buttons/date */
             box-sizing: border-box;
        }
        select.custom-select-input:focus {
            outline: none; border-color: #4f46e5; /* Default focus color, can be themed */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3); /* Default focus shadow */
        }


        /* Modal Scrollbar */
        .modal-content::-webkit-scrollbar { width: 6px; }
        .modal-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb { background: #a5b4fc; border-radius: 10px; } /* Default thumb (indigo-300) */
        .modal-content::-webkit-scrollbar-thumb:hover { background: #818cf8; } /* Default hover (indigo-400) */

        /* Fade In Animation */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Filter Buttons (Used for All and Major Cities) - REFINED for Mobile */
        .filter-button {
            transition: all 0.2s ease-in-out;
            /* REFINED Padding for Mobile */
            padding: 0.375rem 0.75rem; /* py-1.5 px-3 */
            border-radius: 9999px; /* rounded-full */
            font-size: 0.875rem; font-weight: 500; border: 1px solid transparent; /* text-sm font-medium */
            cursor: pointer;
            white-space: nowrap; /* Prevent button text wrapping */
            line-height: 1.25rem; /* Ensure consistent height */
            height: 2.25rem; /* Fixed height to match select/date */
            box-sizing: border-box;
            display: inline-flex; /* Ensure vertical alignment */
            align-items: center; /* Ensure vertical alignment */
        }
        /* Slightly larger padding for larger screens */
         @media (min-width: 640px) {
             .filter-button {
                 padding: 0.375rem 0.875rem; /* py-1.5 px-3.5 */
             }
         }
        .filter-button.active { /* Active state colors set by theme */ }
        .filter-button:not(.active) { background-color: #e5e7eb; color: #374151; border-color: #d1d5db; } /* bg-gray-200 text-gray-700 border-gray-300 */
        .filter-button:not(.active):hover { background-color: #d1d5db; border-color: #9ca3af; } /* hover:bg-gray-300 hover:border-gray-400 */


        /* Suggestion Modal Specific Styles */
        #suggest-modal .modal-content { /* No specific styles needed currently */ }

        /* Base Category Switch Button Styles */
        .category-switch-button {
            padding: 0.6rem 1.2rem; /* Slightly larger padding */
            border-radius: 9999px; /* Pill shape */
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* semibold */
            border: 1px solid rgba(255, 255, 255, 0.2); /* Subtle border */
            color: rgba(255, 255, 255, 0.7); /* Dimmer text */
            background-color: rgba(255, 255, 255, 0.05); /* Very subtle background */
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            white-space: nowrap; /* Prevent button text wrapping */
        }
        .category-switch-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: rgba(255, 255, 255, 0.4);
        }
        .category-switch-button.active {
             color: white;
             box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
             border-color: transparent;
             /* Active background color set by theme */
        }

        /* Location Status Styling */
        #location-status, #location-status-mobile {
            font-size: 0.875rem; /* text-sm */
            padding: 0.5rem 1rem; /* px-4 py-2 */
            border-radius: 0.375rem; /* rounded-md */
            display: inline-flex;
            align-items: center;
            gap: 0.5rem; /* space-x-2 */
            transition: all 0.3s ease;
        }
        .status-pending { background-color: #fef3c7; color: #92400e; border: 1px solid #fde68a; } /* amber */
        .status-success { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; } /* green */
        .status-error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; } /* red */
        .status-unavailable { background-color: #e5e7eb; color: #374151; border: 1px solid #d1d5db; } /* gray */


        /* --- Theme Specific Styles --- */

        /* Default: Finance Theme (Indigo/Blue) */
        .theme-finance { background-color: #f3f4f6; } /* Light gray background */
        .theme-finance .gradient-bg { background: linear-gradient(135deg, #1f2937 0%, #111827 100%); } /* gray-800 to gray-900 */
        .theme-finance .gradient-accent { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); } /* indigo-600 to purple-600 */
        .theme-finance .text-gradient { background: linear-gradient(to right, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; } /* blue-400 to purple-400 */
        .theme-finance .filter-button.active { background-color: #4f46e5; color: white; box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2); } /* indigo-600 */
        .theme-finance .date-badge { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); box-shadow: 0 2px 5px rgba(79, 70, 229, 0.3); }
        .theme-finance #loading i { color: #4f46e5; } /* indigo-600 */
        .theme-finance .category-switch-button.active { background-color: #4f46e5; } /* Active Finance Button: indigo-600 */
        .theme-finance .event-card .view-details { background-color: #eef2ff; color: #4338ca; } /* Indigo light: bg-indigo-50 text-indigo-700 */
        .theme-finance .event-card .view-details:hover { background-color: #e0e7ff; } /* hover:bg-indigo-100 */
        .theme-finance #modal-content .bg-indigo-50 { background-color: #eef2ff; } /* Modal details box */
        .theme-finance #modal-content .border-indigo-100 { border-color: #e0e7ff; }
        .theme-finance #modal-content .text-indigo-600 { color: #4f46e5; } /* Icon/text color in modal date box */
        .theme-finance #modal-content .text-indigo-500 { color: #6366f1; } /* Icon color in modal date box */
        .theme-finance input[type="text"]:focus, .theme-finance .custom-date-input:focus, .theme-finance select.custom-select-input:focus { border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3); }


        /* AI Theme (Teal/Cyan) */
        .theme-ai { background-color: #f0fdfa; } /* Very light teal background (teal-50) */
        .theme-ai .gradient-bg { background: linear-gradient(135deg, #0f766e 0%, #115e59 100%); } /* Darker Teal: teal-700 to teal-800 */
        .theme-ai .gradient-accent { background: linear-gradient(135deg, #14b8a6 0%, #2dd4bf 100%); } /* Teal: teal-500 to cyan-400 */
        .theme-ai .text-gradient { background: linear-gradient(to right, #2dd4bf, #5eead4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; } /* cyan-400 to cyan-300 */
        .theme-ai .filter-button.active { background-color: #14b8a6; color: white; box-shadow: 0 2px 4px rgba(20, 184, 166, 0.2); } /* teal-500 */
        .theme-ai .date-badge { background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); box-shadow: 0 2px 5px rgba(20, 184, 166, 0.3); } /* teal-500 to teal-600 */
        .theme-ai #loading i { color: #14b8a6; } /* teal-500 */
        .theme-ai .category-switch-button.active { background-color: #14b8a6; } /* Active AI Button: teal-500 */
        .theme-ai .event-card .view-details { background-color: #f0fdfa; color: #0f766e; } /* Teal light: bg-teal-50 text-teal-700 */
        .theme-ai .event-card .view-details:hover { background-color: #ccfbf1; } /* hover:bg-teal-100 */
        .theme-ai #modal-content .bg-indigo-50 { background-color: #ccfbf1; } /* Use teal light for modal details box */
        .theme-ai #modal-content .border-indigo-100 { border-color: #99f6e4; } /* teal-200 */
        .theme-ai #modal-content .text-indigo-600 { color: #0d9488; } /* Adjust icon/text colors in modal date box: teal-600 */
        .theme-ai #modal-content .text-indigo-500 { color: #14b8a6; } /* Adjust icon color in modal date box: teal-500 */
        .theme-ai input[type="text"]:focus, .theme-ai .custom-date-input:focus, .theme-ai select.custom-select-input:focus { border-color: #14b8a6; box-shadow: 0 0 0 2px rgba(20, 184, 166, 0.3); }


        /* Cybersecurity Theme (Purple/Pink) */
        .theme-cyber { background-color: #faf5ff; } /* Very light purple background (purple-50) */
        .theme-cyber .gradient-bg { background: linear-gradient(135deg, #581c87 0%, #3730a3 100%); } /* Dark Purple/Indigo: purple-900 to indigo-800 */
        .theme-cyber .gradient-accent { background: linear-gradient(135deg, #a855f7 0%, #d946ef 100%); } /* Purple/Fuchsia: purple-500 to fuchsia-500 */
        .theme-cyber .text-gradient { background: linear-gradient(to right, #c084fc, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; } /* purple-400 to pink-400 */
        .theme-cyber .filter-button.active { background-color: #a855f7; color: white; box-shadow: 0 2px 4px rgba(168, 85, 247, 0.2); } /* purple-500 */
        .theme-cyber .date-badge { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); box-shadow: 0 2px 5px rgba(168, 85, 247, 0.3); } /* purple-500 to purple-600 */
        .theme-cyber #loading i { color: #a855f7; } /* purple-500 */
        .theme-cyber .category-switch-button.active { background-color: #a855f7; } /* Active Cyber Button: purple-500 */
        .theme-cyber .event-card .view-details { background-color: #faf5ff; color: #7e22ce; } /* Purple light: bg-purple-50 text-purple-700 */
        .theme-cyber .event-card .view-details:hover { background-color: #f3e8ff; } /* hover:bg-purple-100 */
        .theme-cyber #modal-content .bg-indigo-50 { background-color: #f5f3ff; } /* Use purple light for modal details box: purple-50 */
        .theme-cyber #modal-content .border-indigo-100 { border-color: #e9d5ff; } /* purple-200 */
        .theme-cyber #modal-content .text-indigo-600 { color: #9333ea; } /* Adjust icon/text colors in modal date box: purple-600 */
        .theme-cyber #modal-content .text-indigo-500 { color: #a855f7; } /* Adjust icon color in modal date box: purple-500 */
        .theme-cyber input[type="text"]:focus, .theme-cyber .custom-date-input:focus, .theme-cyber select.custom-select-input:focus { border-color: #a855f7; box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.3); }

        /* Ensure modal details box text/icons adapt */
         #modal-content .bg-indigo-50 .text-gray-800 { color: #1f2937; } /* Ensure main date text stays dark */

         /* Generic Info Box in Modal (Blue) - Keep consistent across themes or theme if desired */
         #modal-content .bg-blue-50 { background-color: #eff6ff; }
         #modal-content .border-blue-100 { border-color: #dbeafe; }
         #modal-content .text-blue-800 { color: #1e40af; }
         #modal-content .text-blue-700 { color: #1d4ed8; }

    </style>
</head>
<body class="theme-finance"> <header class="gradient-bg text-white">
        <div class="container mx-auto px-4 py-12 md:py-20 text-center">

            <div class="mb-8 flex justify-center gap-x-2 sm:gap-x-4 flex-wrap"> <button id="finance-category-button" class="category-switch-button active">
                    <i class="fas fa-chart-line mr-1.5 sm:mr-2 text-xs sm:text-sm"></i>Finance
                </button>
                <button id="ai-category-button" class="category-switch-button">
                    <i class="fas fa-brain mr-1.5 sm:mr-2 text-xs sm:text-sm"></i>AI
                </button>
                <button id="cyber-category-button" class="category-switch-button">
                    <i class="fas fa-shield-alt mr-1.5 sm:mr-2 text-xs sm:text-sm"></i>Cybersecurity
                </button>
            </div>

            <div class="mb-4">
                <span class="headline-logo logo-text text-gradient">NoLeaf</span>
                 <p class="text-xs text-gray-400">
                     Developed by <a href="https://kamathhrishi.github.io/MyWebsite/about/" target="_blank" rel="noopener noreferrer" class="hover:text-indigo-300 transition-colors underline decoration-dotted">Hrishikesh Kamath</a>
                 </p>
            </div>

            <h1 class="mb-4 max-w-4xl mx-auto">
                 <span class="headline-description">Discover Top <span id="category-title-span">Finance & Investment</span> Events Near You</span>
            </h1>
            <p class="text-base md:text-lg text-gray-400 mb-8 max-w-3xl mx-auto">
                Explore over 1800+ events from all over the US!
            </p>

            <div class="flex flex-wrap gap-4 justify-center">
                <a href="#events-section" class="gradient-accent text-white font-medium rounded-lg px-6 py-3 inline-flex items-center transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    <i class="fas fa-calendar-alt mr-2"></i> Browse Events
                </a>
                <button id="suggest-event-button" class="bg-gray-700 hover:bg-gray-600 text-white font-medium rounded-lg px-6 py-3 inline-flex items-center transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                    <i class="fas fa-plus-circle mr-2"></i> Missing event? Let us know
                </button>
            </div>
        </div>
    </header>

    <section class="bg-white/95 backdrop-blur-sm border-b border-gray-200 shadow-sm">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row md:items-center justify-between flex-wrap gap-y-2 gap-x-2 sm:gap-x-3"> <div id="location-filters-container" class="flex items-center justify-center md:justify-start gap-x-1.5 gap-y-1 flex-shrink-0 order-1 md:order-1 flex-wrap"> <button id="all-locations-filter" data-location="all" class="filter-button active">All Locations</button>

                     <div id="finance-major-cities" class="flex gap-x-1.5 gap-y-1 flex-wrap"> <button data-location="New York, NY" class="filter-button major-city-button">New York</button>
                         <button data-location="Philadelphia, PA" class="filter-button major-city-button">Philadelphia</button>
                     </div>
                     <div id="tech-major-cities" class="hidden flex gap-x-1.5 gap-y-1 flex-wrap"> <button data-location="San Francisco, CA" class="filter-button major-city-button">SF Bay Area</button>
                         <button data-location="Seattle, WA" class="filter-button major-city-button">Seattle</button>
                         <button data-location="Austin, TX" class="filter-button major-city-button">Austin</button>
                         <button data-location="Boston, MA" class="filter-button major-city-button">Boston</button>
                     </div>

                     <div class="relative">
                         <select id="hidden location-dropdown" class="hidden custom-select-input">
                             <option value="all">More Cities...</option>
                             </select>
                     </div>
                 </div>

                 <div class="relative flex-grow md:max-w-xs lg:max-w-sm w-full order-3 md:order-2">
                     <input type="text" id="search-input"
                             placeholder="Search..."
                             class="w-full pl-9 pr-4 py-1.5 border border-gray-300 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition h-[2.25rem] box-border"> <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i> </div>

                 <div class="flex flex-col sm:flex-row items-center justify-center sm:justify-end gap-x-2 gap-y-2 w-full md:w-auto order-2 md:order-3"> <div id="location-status" class="status-pending mr-0 sm:mr-2 hidden md:inline-flex"> <i class="fas fa-map-marker-alt"></i>
                         <span>Getting location...</span>
                     </div>
                     <label for="start-date" class="text-sm font-medium text-gray-600 flex-shrink-0 whitespace-nowrap hidden sm:inline">From:</label> <input type="date" id="start-date" class="custom-date-input w-full sm:w-auto" aria-label="Start Date">
                     <label for="end-date" class="text-sm font-medium text-gray-600 ml-0 sm:ml-1 flex-shrink-0 whitespace-nowrap hidden sm:inline">To:</label> <input type="date" id="end-date" class="custom-date-input w-full sm:w-auto" aria-label="End Date">
                 </div>
            </div>
             <div id="mobile-location-status-container" class="hidden text-center pt-2"> <div id="location-status-mobile" class="hidden status-pending"> <i class="fas fa-map-marker-alt"></i>
                     <span>Getting location...</span>
                 </div>
             </div>
        </div>
    </section>

    <section id="events-section" class="py-12 md:py-16">
        <div class="container mx-auto px-4">
            <div class="mb-10 md:flex justify-between items-center">
                 <div>
                     <h2 class="text-3xl font-bold text-gray-800 mb-1">Upcoming Events</h2>
                     <div id="event-count" class="text-gray-600">Loading events...</div>
                 </div>
                 <div id="current-date-range" class="flex items-center text-sm text-gray-500 mt-2 md:mt-0 bg-gray-200 px-3 py-1.5 rounded-full">
                     <i class="far fa-calendar-alt mr-2 text-gray-600"></i>
                     <span id="date-range-display">All Dates</span>
                 </div>
            </div>

            <div id="loading" class="loading-animate text-center py-16">
                 <div class="inline-block p-8 bg-white rounded-lg shadow-md">
                     <i class="fas fa-spinner fa-spin text-5xl text-indigo-500 mb-4"></i>
                     <p class="text-gray-700 text-lg font-medium">Loading Events</p>
                     <p class="text-gray-500 text-sm mt-1">Fetching the latest event data...</p>
                 </div>
            </div>

            <div id="events-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                 </div>

            <div id="no-events" class="hidden text-center py-16 bg-white rounded-lg shadow-sm mt-8">
                 <i class="fas fa-calendar-times text-6xl text-gray-300 mb-5"></i>
                 <p id="no-events-message" class="text-gray-700 text-xl font-semibold">No events found.</p>
                 <p class="text-gray-500 mt-2">Try adjusting your search terms or date filters.</p>
            </div>

            <div id="pagination-controls" class="flex justify-center items-center space-x-3 md:space-x-4 mt-10 mb-4 hidden">
                 <button id="prev-page" class="bg-white hover:bg-gray-100 border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center shadow-sm disabled:shadow-none">
                     <i class="fas fa-chevron-left mr-2 text-xs"></i> Prev
                 </button>
                 <span id="page-info" class="text-gray-600 text-sm font-medium px-2">Page 1 of 1</span>
                 <button id="next-page" class="bg-white hover:bg-gray-100 border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center shadow-sm disabled:shadow-none">
                     Next <i class="fas fa-chevron-right ml-2 text-xs"></i>
                 </button>
            </div>
        </div>
    </section>

    <footer class="bg-gray-800 text-white py-12">
        <div class="container mx-auto px-4 text-center">
            <div class="mb-6">
                 <div class="inline-flex items-center justify-center mb-2">
                      <span class="text-2xl font-bold logo-text text-gradient">NoLeaf</span>
                 </div>
                 <p class="text-gray-400 max-w-lg mx-auto text-sm">
                     Your premier destination for the most exhaustive list of professional events across the United States. Stay ahead of the curve.
                 </p>
            </div>
              <div class="mt-8 pt-8 border-t border-gray-700">
                 <p class="text-gray-500 text-sm">&copy; 2025 NoLeaf. All rights reserved. | <a href="#" class="hover:text-indigo-300">Privacy Policy</a></p>
             </div>
        </div>
    </footer>

    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden p-4 fade-in">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="p-5 md:p-6 flex justify-between items-center border-b border-gray-200 bg-gray-50">
                <h3 id="modal-title" class="text-xl md:text-2xl font-semibold text-gray-800 pr-4 leading-tight">Event Title Placeholder</h3>
                <button id="close-modal" class="text-gray-400 hover:text-red-600 transition-colors rounded-full p-1 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modal-content" class="p-5 md:p-8 overflow-y-auto modal-content flex-grow space-y-6">
                 </div>
            <div class="p-5 md:p-6 border-t border-gray-200 bg-gray-50 flex justify-end">
                <a id="modal-link" href="#" target="_blank" rel="noopener noreferrer" class="gradient-accent hover:opacity-90 text-white font-medium rounded-lg px-6 py-2.5 inline-flex items-center transition-all shadow hover:shadow-md transform hover:-translate-y-0.5">
                    View Event Website <i class="fas fa-external-link-alt ml-2 text-xs"></i>
                </a>
            </div>
        </div>
    </div>

    <div id="suggest-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden p-4 fade-in">
        <div class="bg-white rounded-xl max-w-lg w-full max-h-[90vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="p-5 md:p-6 flex justify-between items-center border-b border-gray-200 bg-gray-50">
                <h3 class="text-xl font-semibold text-gray-800 pr-4 leading-tight flex items-center">
                    <i class="fas fa-lightbulb mr-3 text-yellow-500"></i> Suggest an Event
                </h3>
                <button id="close-suggest-modal" class="text-gray-400 hover:text-red-600 transition-colors rounded-full p-1 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-5 md:p-8 overflow-y-auto modal-content flex-grow space-y-4">
                 <p class="text-gray-700 leading-relaxed">
                     Know of a great finance, AI, or cybersecurity event in the US that we missed? We'd love to hear about it!
                 </p>
                 <p class="text-gray-700 leading-relaxed">
                     Please send the event details (name, date, location, website link) to:
                 </p>
                 <div class="bg-indigo-50 border border-indigo-200 rounded-md p-3 text-center">
                     <a href="mailto:kamathhrishi@gmail.com" class="text-indigo-700 font-medium hover:text-indigo-900 hover:underline break-all">
                          <i class="fas fa-envelope mr-2"></i>kamathhrishi@gmail.com
                     </a>
                 </div>
                 <p class="text-sm text-gray-500 mt-3">
                     We'll review your suggestion and add it if it fits our criteria. Thanks for helping keep NoLeaf up-to-date!
                 </p>
            </div>
            <div class="p-4 md:p-5 border-t border-gray-200 bg-gray-50 flex justify-end">
                 <button id="suggest-modal-close-button-alt" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg px-5 py-2 transition-colors">
                     Close
                 </button>
            </div>
        </div>
    </div>


    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // --- Global State ---
        let allEvents = []; // Holds ALL processed, combined, deduplicated events for the current category
        let currentFilteredEvents = []; // Holds events matching current filters
        let currentPage = 1; // Current page number for pagination
        let totalPages = 1; // Total number of pages based on filtered events
        let itemsPerPage = 6; // Default for large screens
        let currentCategory = 'finance'; // Default category
        let userLocation = null; // User's geolocation { lat: number, lon: number } | null
        let locationStatus = 'pending'; // Geolocation status
        let isDistanceSortActive = true; // Flag for sorting

        // --- Configuration ---
        const categories = {
            finance: {
                name: 'Finance & Investment',
                // *** CHANGED: Use 'urls' array for potentially multiple sources ***
                urls: [
                    'https://raw.githubusercontent.com/kamathhrishi/noleaf/refs/heads/main/events.csv',
                    'https://raw.githubusercontent.com/kamathhrishi/noleaf/main/events_finance.csv'
                ],
                themeClass: 'theme-finance',
                buttonId: 'finance-category-button',
                titleText: 'Finance & Investment',
                majorCitySetId: 'finance-major-cities',
                 // *** CHANGED: Use 'columnConfigs' array matching the 'urls' array ***
                 // Assuming both CSVs use the same relevant column names.
                 // Verify these match the actual columns in BOTH files if necessary.
                columnConfigs: [
                    { dateCol: "Event Date", titleCol: "Title", descCol: "Description", urlCol: "URL", locCol: "Event City" }, // Config for events.csv
                    { dateCol: "Event Date", titleCol: "Title", descCol: "Description", urlCol: "URL", locCol: "Event City" }  // Config for events_finance.csv
                ]
            },
            ai: {
                name: 'AI',
                 // *** CHANGED: Keep single url as string for non-finance categories ***
                urls: ['https://raw.githubusercontent.com/kamathhrishi/noleaf/main/events_ai.csv'],
                themeClass: 'theme-ai',
                buttonId: 'ai-category-button',
                titleText: 'Artificial Intelligence',
                majorCitySetId: 'tech-major-cities',
                 // *** CHANGED: Wrap single config in array for consistency ***
                columnConfigs: [{ dateCol: "Event Date", titleCol: "Title", descCol: "Description", urlCol: "URL", locCol: "Event City" }]
            },
            cyber: {
                name: 'Cybersecurity',
                 // *** CHANGED: Keep single url as string for non-finance categories ***
                urls: ['https://raw.githubusercontent.com/kamathhrishi/noleaf/main/events_cyber.csv'],
                themeClass: 'theme-cyber',
                buttonId: 'cyber-category-button',
                titleText: 'Cybersecurity',
                majorCitySetId: 'tech-major-cities',
                // *** CHANGED: Wrap single config in array for consistency ***
                columnConfigs: [{ dateCol: "Event Date", titleCol: "Title", descCol: "Description", urlCol: "URL", locCol: "Event City" }]
            }
        };

        // --- Major City Definitions ---
        const majorCityAliases = {
             'New York, NY': ['new york', 'nyc'],
             'Philadelphia, PA': ['philadelphia', 'philly'],
             'San Francisco, CA': ['san francisco', 'bay area', 'palo alto', 'mountain view', 'san jose', 'menlo park', 'santa clara'],
             'Seattle, WA': ['seattle', 'redmond', 'bellevue'],
             'Austin, TX': ['austin'],
             'Boston, MA': ['boston', 'cambridge'],
         };

        // --- Pre-compiled City Coordinates ---
        const cityCoordinates = {
            // Finance Hubs
            "new york, ny": { lat: 40.7128, lon: -74.0060 },
            "philadelphia, pa": { lat: 39.9526, lon: -75.1652 },
            // Tech Hubs
            "san francisco, ca": { lat: 37.7749, lon: -122.4194 },
            "palo alto, ca": { lat: 37.4419, lon: -122.1430 },
            "mountain view, ca": { lat: 37.3861, lon: -122.0839 },
            "san jose, ca": { lat: 37.3387, lon: -121.8853 },
            "menlo park, ca": { lat: 37.4541, lon: -122.1833 },
            "santa clara, ca": { lat: 37.3541, lon: -121.9552 },
            "seattle, wa": { lat: 47.6062, lon: -122.3321 },
            "redmond, wa": { lat: 47.6740, lon: -122.1215 },
            "bellevue, wa": { lat: 47.6101, lon: -122.2015 },
            "austin, tx": { lat: 30.2672, lon: -97.7431 },
            "boston, ma": { lat: 42.3601, lon: -71.0589 },
            "cambridge, ma": { lat: 42.3736, lon: -71.1097 },
            // Other examples
            "san diego, ca": { lat: 32.7157, lon: -117.1611 },
            "las vegas, nv": { lat: 36.1699, lon: -115.1398 },
            "newark, de": { lat: 39.6837, lon: -75.7497 }, // Delaware
            "newark, nj": { lat: 40.7357, lon: -74.1724 }, // New Jersey!
            "chicago, il": { lat: 41.8781, lon: -87.6298 },
            "los angeles, ca": { lat: 34.0522, lon: -118.2437 },
            "dallas, tx": { lat: 32.7767, lon: -96.7970 },
            "houston, tx": { lat: 29.7604, lon: -95.3698 },
            "miami, fl": { lat: 25.7617, lon: -80.1918 },
            "atlanta, ga": { lat: 33.7490, lon: -84.3880 },
            "denver, co": { lat: 39.7392, lon: -104.9903 },
            "washington, dc": { lat: 38.9072, lon: -77.0369 }
            // Add more cities and their coordinates here...
        };

        // --- DOM Elements ---
        const eventsContainer = document.getElementById('events-container');
        const loadingIndicator = document.getElementById('loading');
        const noEventsIndicator = document.getElementById('no-events');
        const noEventsMessage = document.getElementById('no-events-message');
        const eventCountEl = document.getElementById('event-count');
        const paginationControlsEl = document.getElementById('pagination-controls');
        const prevPageButton = document.getElementById('prev-page');
        const nextPageButton = document.getElementById('next-page');
        const pageInfoEl = document.getElementById('page-info');
        const searchInput = document.getElementById('search-input');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const dateRangeDisplay = document.getElementById('date-range-display');
        const locationStatusEl = document.getElementById('location-status');
        const locationStatusMobileEl = document.getElementById('location-status-mobile');
        const mobileLocationStatusContainer = document.getElementById('mobile-location-status-container');
        const eventModal = document.getElementById('event-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalLink = document.getElementById('modal-link');
        const closeModalButton = document.getElementById('close-modal');
        const suggestEventButton = document.getElementById('suggest-event-button');
        const suggestModal = document.getElementById('suggest-modal');
        const closeSuggestModalButton = document.getElementById('close-suggest-modal');
        const suggestModalCloseButtonAlt = document.getElementById('suggest-modal-close-button-alt');
        const categoryTitleSpan = document.getElementById('category-title-span');
        const locationFiltersContainer = document.getElementById('location-filters-container');
        const allLocationsFilterButton = document.getElementById('all-locations-filter');
        const locationDropdown = document.getElementById('location-dropdown');
        const financeMajorCitiesDiv = document.getElementById('finance-major-cities');
        const techMajorCitiesDiv = document.getElementById('tech-major-cities');
        const majorCityButtons = document.querySelectorAll('.major-city-button');
        const eventSchemaPlaceholder = document.getElementById('event-schema-placeholder');


        // --- Helper Functions ---

        function formatDateToYyyyMmDd(date) {
            if (!date || isNaN(date.getTime())) return '';
            const year = date.getUTCFullYear();
            const month = (date.getUTCMonth() + 1).toString().padStart(2, '0');
            const day = date.getUTCDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function escapeHTML(str) {
            if (typeof str !== 'string') return str;
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#39;');
        }

        function parseDate(dateStr, eventRow = null) {
            if (typeof dateStr !== 'string' || !dateStr) return new Date(NaN);
            let date = new Date(NaN);
            const trimmedDateStr = dateStr.trim();

            if (/^\d{4}-\d{2}-\d{2}/.test(trimmedDateStr)) {
                date = new Date(trimmedDateStr.substring(0, 10) + 'T00:00:00Z');
                if (!isNaN(date.getTime())) return date;
                date = new Date(NaN);
            }

            if (/^\d{1,2}\/\d{1,2}\/\d{4}/.test(trimmedDateStr)) {
                const datePart = trimmedDateStr.split(' ')[0];
                const parts = datePart.split('/');
                if (parts.length === 3) {
                    date = new Date(Date.UTC(parseInt(parts[2], 10), parseInt(parts[0], 10) - 1, parseInt(parts[1], 10)));
                    if (!isNaN(date.getTime())) return date;
                    date = new Date(NaN);
                }
            }

            if (isNaN(date.getTime())) {
                const potentialDate = new Date(trimmedDateStr.includes('UTC') ? trimmedDateStr : trimmedDateStr + ' UTC');
                 if (!isNaN(potentialDate.getTime())) {
                     date = new Date(Date.UTC(potentialDate.getUTCFullYear(), potentialDate.getUTCMonth(), potentialDate.getUTCDate()));
                     if (!isNaN(date.getTime())) return date;
                     date = new Date(NaN);
                 }
            }

            const currentConfig = categories[currentCategory];
            if (isNaN(date.getTime()) && currentCategory === 'ai' && eventRow && eventRow['Event date'] && dateStr !== eventRow['Event date']) {
                const fallbackDateStr = eventRow['Event date'];
                date = parseDate(fallbackDateStr);
                if (!isNaN(date.getTime())) return date;
                date = new Date(NaN);
            }

            //if (isNaN(date.getTime())) { console.warn(`Could not parse date: "${dateStr}"`); }
            return date;
        }

        function formatDate(date) {
            if (!date || isNaN(date.getTime())) return "Invalid Date";
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' };
            try { return date.toLocaleDateString('en-US', options); }
            catch (e) { console.error("Error formatting date:", e); return "Invalid Date"; }
        }

        function formatShortDate(date) {
            if (!date || isNaN(date.getTime())) return "N/A";
            const options = { month: 'short', day: 'numeric', timeZone: 'UTC' };
             try { return date.toLocaleDateString('en-US', options); }
             catch (e) { console.error("Error formatting short date:", e); return "N/A"; }
        }

        function formatDisplayDate(dateStr) {
             if (!dateStr) return null;
             const parts = dateStr.split('-');
             if (parts.length !== 3) return null;
             const year = parseInt(parts[0], 10);
             const month = parseInt(parts[1], 10) - 1;
             const day = parseInt(parts[2], 10);
             const date = new Date(Date.UTC(year, month, day));
             if (!isNaN(date.getTime())) {
                 const displayMonth = date.toLocaleString('en-US', { month: 'short', timeZone: 'UTC' });
                 const displayDay = date.getUTCDate();
                 const displayYear = date.getUTCFullYear();
                 return `${displayMonth} ${displayDay}, ${displayYear}`;
             }
             return null;
         }

        function getUtcMidnight(date) {
            if (!date || isNaN(date.getTime())) return null;
            return new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            if (lat1 == null || lon1 == null || lat2 == null || lon2 == null) {
                return Infinity;
            }
            const R = 6371; // Radius of the Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;
            return distance;
        }

        function parseLocationString(locStr) {
            const result = { city: null, state: null, original: locStr };
            if (!locStr || typeof locStr !== 'string') return result;

            const trimmed = locStr.trim();
            const commaMatch = trimmed.match(/^(.*?),\s*([A-Za-z. ]{2,})$/);

            if (commaMatch) {
                result.city = commaMatch[1].trim().toLowerCase();
                let potentialState = commaMatch[2].trim().toLowerCase();
                potentialState = potentialState.replace(/\./g, '');
                result.state = potentialState;
            } else {
                if (!/^[A-Za-z]{2}$/.test(trimmed)) {
                     result.city = trimmed.toLowerCase();
                } else {
                     result.city = 'unknown';
                     result.state = trimmed.toLowerCase();
                }
            }
            if (result.city === 'washington d c') {
                result.city = 'washington';
                result.state = 'dc';
            }

            return result;
        }

        // --- Theme and UI Management ---

        function updateMajorCityButtonsUI(categoryKey) {
             const categoryConfig = categories[categoryKey];
             if (!financeMajorCitiesDiv || !techMajorCitiesDiv || !categoryConfig) return;
             financeMajorCitiesDiv.classList.add('hidden');
             techMajorCitiesDiv.classList.add('hidden');
             const citySetToShow = document.getElementById(categoryConfig.majorCitySetId);
             if (citySetToShow) {
                 citySetToShow.classList.remove('hidden');
             } else {
                 console.error(`Major city set ID not found: ${categoryConfig.majorCitySetId}`);
             }
         }

        function updateLocationStatusUI() {
            if (mobileLocationStatusContainer) mobileLocationStatusContainer.classList.add('hidden');
             if (locationStatusMobileEl) locationStatusMobileEl.classList.add('hidden');
            if (!locationStatusEl) return;

            let iconClass = 'fa-map-marker-alt';
            let text = '';
            let statusClass = '';

            switch (locationStatus) {
                case 'pending':
                    iconClass = 'fa-spinner fa-spin'; text = 'Getting location...'; statusClass = 'status-pending'; break;
                case 'success':
                    iconClass = 'fa-check-circle'; text = 'Sorting nearby'; statusClass = 'status-success'; break;
                case 'error':
                    iconClass = 'fa-exclamation-triangle'; text = 'Location error'; statusClass = 'status-error'; break;
                case 'unavailable': default:
                    iconClass = 'fa-map-marker-slash'; text = 'Location N/A'; statusClass = 'status-unavailable'; break;
            }

            const desktopVisibilityClass = 'hidden md:inline-flex';
            locationStatusEl.className = `location-status ${statusClass} ${desktopVisibilityClass}`;
            locationStatusEl.innerHTML = `<i class="fas ${iconClass}"></i><span>${escapeHTML(text)}</span>`;
        }

        function applyTheme(categoryKey) {
            const categoryConfig = categories[categoryKey];
            if (!categoryConfig) {
                console.error(`Invalid category key for theme: ${categoryKey}`); return;
            }
            const themeClass = categoryConfig.themeClass;
            const buttonId = categoryConfig.buttonId;
            const titleText = categoryConfig.titleText;

            console.log(`Applying theme for: ${categoryKey} (${themeClass})`);

            Object.values(categories).forEach(cat => { document.body.classList.remove(cat.themeClass); });
            document.body.classList.add(themeClass);
            currentCategory = categoryKey;

            Object.values(categories).forEach(cat => {
                const btn = document.getElementById(cat.buttonId); if(btn) btn.classList.remove('active');
            });
            const activeBtn = document.getElementById(buttonId); if(activeBtn) activeBtn.classList.add('active');

            if (categoryTitleSpan) categoryTitleSpan.innerHTML = escapeHTML(titleText);
            if (searchInput) searchInput.placeholder = `Search ${escapeHTML(titleText)} events...`;

            updateMajorCityButtonsUI(categoryKey);
            resetLocationFilters();
        }

        function resetLocationFilters() {
             locationFiltersContainer?.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
             if (allLocationsFilterButton) allLocationsFilterButton.classList.add('active');
             if (locationDropdown) locationDropdown.value = 'all';
             isDistanceSortActive = userLocation !== null;
             console.log("Location filters reset. Distance sort active:", isDistanceSortActive);
         }

        // --- Geolocation ---

        function getUserLocation() {
            locationStatus = 'pending';
            isDistanceSortActive = false;
            updateLocationStatusUI();

            if (!navigator.geolocation) {
                console.log("Geolocation is not supported.");
                locationStatus = 'unavailable';
                updateLocationStatusUI();
                loadEventsForCategory(); // Trigger load without location
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = { lat: position.coords.latitude, lon: position.coords.longitude };
                    console.log("User location obtained:", userLocation);
                    locationStatus = 'success';
                    isDistanceSortActive = getActiveLocationFilter() === 'all';
                    updateLocationStatusUI();
                    loadEventsForCategory(); // Trigger load with location
                },
                (error) => {
                    console.error("Error getting user location:", error.message);
                    userLocation = null;
                    locationStatus = error.code === error.PERMISSION_DENIED ? 'error' : 'unavailable';
                    isDistanceSortActive = false;
                    updateLocationStatusUI();
                    loadEventsForCategory(); // Trigger load without location
                },
                { enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 }
            );
        }


        // --- Core Logic: Data Loading and Processing ---

        function setDefaultDateRange() {
            const today = new Date();
            const startOfTodayUTC = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
            const threeMonthsFromTodayUTC = new Date(startOfTodayUTC);
            threeMonthsFromTodayUTC.setUTCMonth(startOfTodayUTC.getUTCMonth() + 3);
            const defaultStartDateStr = formatDateToYyyyMmDd(startOfTodayUTC);
            const defaultEndDateStr = formatDateToYyyyMmDd(threeMonthsFromTodayUTC);
            if (startDateInput) startDateInput.value = defaultStartDateStr;
            if (endDateInput) endDateInput.value = defaultEndDateStr;
            updateDateRangeDisplay();
        }

        /**
         * *** NEW: Loads event data for the current category, handling single or multiple URLs. ***
         */
        function loadEventsForCategory() {
            const categoryConfig = categories[currentCategory];
            if (!categoryConfig || !categoryConfig.urls || categoryConfig.urls.length === 0) {
                console.error(`No URLs defined for category: ${currentCategory}`);
                handleCSVError(`Configuration error for ${currentCategory}.`);
                return;
            }

            const urlsToFetch = categoryConfig.urls;
            const columnConfigs = categoryConfig.columnConfigs;

            console.log(`Loading CSV(s) for category '${currentCategory}':`, urlsToFetch);
            showLoadingState();

            // Create an array of Promises, one for each URL to parse
            const parsePromises = urlsToFetch.map(url => {
                return new Promise((resolve, reject) => {
                    Papa.parse(url, {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            // Check for PapaParse specific errors within results
                            if (results.errors && results.errors.length > 0) {
                                console.warn(`Parsing errors for ${url}:`, results.errors);
                                // Optionally resolve with errors or partial data, or reject
                                // For simplicity, we'll resolve but the handler needs to check results.errors
                            }
                             resolve(results);
                        },
                        error: (err) => {
                            console.error(`Network or file error for ${url}:`, err);
                             // Reject the promise for this specific URL
                            reject(new Error(`Failed to load or parse ${url}. Error: ${err.message}`));
                        }
                    });
                });
            });

            // Wait for all parsing Promises to settle (either resolve or reject)
            Promise.allSettled(parsePromises)
                .then(settledResults => {
                    // Filter out rejected promises and extract resolved values (PapaParse results)
                    const successfulResults = settledResults
                        .filter(result => result.status === 'fulfilled')
                        .map(result => result.value);

                    // Log any failures
                    settledResults.forEach((result, index) => {
                        if (result.status === 'rejected') {
                             console.error(`Failed to load data from ${urlsToFetch[index]}:`, result.reason);
                        }
                    });

                    // Proceed if at least one CSV was loaded successfully
                    if (successfulResults.length > 0) {
                         handleParsedData(successfulResults, columnConfigs);
                    } else {
                         // Handle case where ALL fetches failed
                         console.error(`All CSV fetches failed for category ${currentCategory}.`);
                         handleCSVError(`Could not fetch any data for ${categoryConfig.name}.`);
                    }
                });
                // Note: No .catch here because Promise.allSettled doesn't reject overall
                // unless there's a programming error *before* the promises start.
                // Individual fetch/parse errors are handled within the .then block.
        }

        /**
         * Sets the UI to a loading state.
         */
        function showLoadingState() {
             if(loadingIndicator) loadingIndicator.style.display = 'block';
             if(eventsContainer) eventsContainer.innerHTML = '';
             if(noEventsIndicator) noEventsIndicator.classList.add('hidden');
             if(paginationControlsEl) paginationControlsEl.classList.add('hidden');
             if(eventCountEl) eventCountEl.innerHTML = `Loading ${categories[currentCategory]?.name || ''} events...`;
             allEvents = [];
             currentFilteredEvents = [];
             currentPage = 1;
             populateLocationDropdown([]); // Clear dropdown
        }

        /**
         * *** REVISED: Handles an array of parsed CSV results, combines, deduplicates, sorts, and updates UI. ***
         * @param {Array<object>} resultsArray - Array of results objects from PapaParse for each successfully loaded CSV.
         * @param {Array<object>} columnConfigsArray - Array of column configurations corresponding to each results object.
         */
        function handleParsedData(resultsArray, columnConfigsArray) {
             try {
                if(loadingIndicator) loadingIndicator.style.display = 'none'; // Hide loading indicator

                let combinedProcessedEvents = [];
                let totalRowsProcessed = 0;

                // Process data from each successful result
                resultsArray.forEach((results, index) => {
                    if (results.data && results.data.length > 0) {
                        const columnNames = columnConfigsArray[index]; // Get the correct column config for this file
                        if (!columnNames) {
                            console.error(`Missing column configuration for result index ${index}, category ${currentCategory}`);
                            return; // Skip this result if config is missing
                        }
                         // Process the raw data for this specific file
                        const processedFromFile = processEvents(results.data, columnNames);
                        combinedProcessedEvents = combinedProcessedEvents.concat(processedFromFile);
                        totalRowsProcessed += results.data.length; // Count raw rows for logging
                    } else if (results.errors && results.errors.length > 0) {
                         // Log errors from this specific file if processing happened but had issues
                         console.warn(`CSV Parsing Errors encountered in source ${index}:`, results.errors);
                    }
                });

                console.log(`Total raw rows processed across all sources for ${currentCategory}: ${totalRowsProcessed}`);
                console.log(`Events after initial processing (before deduplication): ${combinedProcessedEvents.length}`);

                 if (combinedProcessedEvents.length === 0) {
                     showNoEventsMessage(`No valid ${categories[currentCategory]?.name || 'event'} data found in the source(s).`);
                     updateEventCount(0);
                     populateLocationDropdown([]);
                     return;
                 }

                // *** ADDED: Deduplication Step ***
                const seenEvents = new Set();
                const deduplicatedEvents = [];
                combinedProcessedEvents.forEach(event => {
                    if (!event || !event.date || isNaN(event.date.getTime()) || !event.url || !event.location || !event.title) {
                        console.warn("Skipping event with missing critical data during deduplication:", event);
                        return; // Skip incomplete events before creating key
                    }
                    // Create a unique key based on Title, Date (time), Location, and URL
                    const uniqueKey = `${event.title.toLowerCase()}|${event.date.getTime()}|${event.location.toLowerCase()}|${event.url}`;
                    if (!seenEvents.has(uniqueKey)) {
                        seenEvents.add(uniqueKey);
                        deduplicatedEvents.push(event);
                    }
                });
                console.log(`Events after deduplication: ${deduplicatedEvents.length}`);


                // *** ADDED: Initial Sort by Date (Ascending) After Deduplication ***
                const finalEvents = deduplicatedEvents.sort((a, b) => a.date - b.date);

                // Update global state with the final, combined, deduplicated, sorted list
                allEvents = finalEvents;
                currentFilteredEvents = [...allEvents]; // Initially, filtered list is the full list
                currentPage = 1; // Reset to first page

                // Populate UI elements
                populateLocationDropdown(allEvents);
                applyFiltersAndDisplay(); // Apply default date filters and display the first page

            } catch (error) {
                console.error("Error in handleParsedData:", error);
                handleCSVError(`Error processing combined ${categories[currentCategory]?.name || 'event'} data.`);
            }
        }

        function handleCSVError(message = `Could not load ${categories[currentCategory]?.name || 'event'} data.`) {
            if(loadingIndicator) loadingIndicator.style.display = 'none';
            showNoEventsMessage(message);
            updateEventCount(0);
            if(paginationControlsEl) paginationControlsEl.classList.add('hidden');
            allEvents = [];
            currentFilteredEvents = [];
            populateLocationDropdown([]);
        }

        /**
         * *** REVISED: Processes raw event data - validates, parses, adds placeholders. Does NOT sort/deduplicate here. ***
         * @param {Array<object>} data - Array of raw event objects from PapaParse.
         * @param {object} columnNames - Object mapping generic names to actual CSV column headers for THIS specific data array.
         * @returns {Array<object>} Array of processed and validated event objects (not yet deduplicated or sorted).
         */
        function processEvents(data, columnNames) {
            // console.log("Processing raw data rows with columns:", columnNames); // Debug which config is used
            if (!data || data.length === 0 || !columnNames) return [];

            const { dateCol, titleCol, descCol, urlCol, locCol } = columnNames;
            let skippedDateCount = 0, skippedUrlCount = 0, skippedLocationCount = 0, processedCount = 0;

            const processed = data
                .map((event, index) => {
                    // Basic validation
                    if (!event || !event[dateCol] || !event[titleCol] || !event[urlCol] || !event[locCol]) {
                        // console.warn(`Skipping row ${index + 2}: Missing essential data.`);
                        return null;
                    }

                    // Parse Date
                    let eventDate = parseDate(event[dateCol], event);
                    if (isNaN(eventDate.getTime())) {
                        // console.warn(`Skipping row ${index + 2}: Invalid date "${event[dateCol]}"`);
                        skippedDateCount++; return null;
                    }

                    // Validate URL
                    const url = String(event[urlCol] || '').trim();
                    if (!url || url === '#') {
                        // console.warn(`Skipping row ${index + 2}: Invalid URL "${event[urlCol]}"`);
                        skippedUrlCount++; return null;
                    }

                    // Process Location(s)
                    const originalLocationString = String(event[locCol] || '').trim();
                    if (!originalLocationString) {
                        // console.warn(`Skipping row ${index + 2}: Missing location`);
                        skippedLocationCount++; return null;
                    }

                    const parsedLocationsData = originalLocationString.split(';')
                        .map(locStr => parseLocationString(locStr.trim()))
                        .filter(parsed => parsed.city && parsed.city !== 'unknown');

                    if (parsedLocationsData.length === 0) {
                        // console.warn(`Skipping row ${index + 2}: Could not parse valid city from "${originalLocationString}"`);
                        skippedLocationCount++; return null;
                    }

                    const locationsWithCoords = parsedLocationsData.map(parsedLoc => {
                        let lookupKey = parsedLoc.city;
                        if (parsedLoc.state) lookupKey = `${parsedLoc.city}, ${parsedLoc.state}`;
                        const coords = cityCoordinates[lookupKey] || cityCoordinates[parsedLoc.city];
                        return { ...parsedLoc, coords: coords || null };
                    });

                    processedCount++;
                    return {
                        title: String(event[titleCol] || 'Untitled Event').trim(),
                        description: String(event[descCol] || 'No description available.').trim(),
                        url: url,
                        date: eventDate,
                        formattedDate: formatDate(eventDate),
                        shortDate: formatShortDate(eventDate),
                        location: originalLocationString,
                        allLocationData: locationsWithCoords,
                        month: eventDate.toLocaleString('default', { month: 'short', timeZone: 'UTC' }),
                        day: eventDate.getUTCDate(),
                        distance: Infinity
                    };
                })
                .filter(event => event !== null); // Remove null entries

             // Log summary for this specific file processing run
             // console.log(`Finished processing batch. Valid: ${processed.length}, Skipped Dates: ${skippedDateCount}, Skipped URLs: ${skippedUrlCount}, Skipped Locs: ${skippedLocationCount}.`);

            // *** REMOVED Sorting - will happen after combining and deduplicating ***
            return processed;
        }


        function populateLocationDropdown(events) {
             if (!locationDropdown) return;
             const uniqueLocationStrings = new Set();
             const majorCityButtonLocations = new Set();

             const currentMajorCitySetId = categories[currentCategory]?.majorCitySetId;
             const visibleMajorCityDiv = document.getElementById(currentMajorCitySetId);
             visibleMajorCityDiv?.querySelectorAll('.major-city-button').forEach(btn => {
                 majorCityButtonLocations.add(btn.dataset.location?.toLowerCase());
             });

             events.forEach(event => {
                 event.allLocationData.forEach(locData => {
                     if (locData.city && locData.city !== 'unknown') {
                         const locStringLower = locData.state ? `${locData.city}, ${locData.state}` : locData.city;
                         if (!majorCityButtonLocations.has(locStringLower)) {
                             uniqueLocationStrings.add(locStringLower);
                         }
                     }
                 });
             });

             const sortedLocations = [...uniqueLocationStrings].sort((a, b) => a.localeCompare(b));

             locationDropdown.innerHTML = '<option value="all">More Cities...</option>';
             sortedLocations.forEach(locStr => {
                 const option = document.createElement('option');
                 option.value = escapeHTML(locStr);
                 option.textContent = escapeHTML(locStr.split(', ').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join(', '));
                 locationDropdown.appendChild(option);
             });
              locationDropdown.value = 'all';
         }


        // --- Core Logic: Display and UI Updates ---

        function displayCurrentPage() {
             if (!eventsContainer || !noEventsIndicator || !paginationControlsEl) return;

             eventsContainer.innerHTML = '';
             noEventsIndicator.classList.add('hidden');

             const screenWidth = window.innerWidth;
             if (screenWidth < 640) { itemsPerPage = 3; }
             else if (screenWidth < 1024) { itemsPerPage = 6; }
             else { itemsPerPage = 6; }

             totalPages = Math.max(1, Math.ceil(currentFilteredEvents.length / itemsPerPage));
             currentPage = Math.max(1, Math.min(currentPage, totalPages));

             const startIndex = (currentPage - 1) * itemsPerPage;
             const endIndex = startIndex + itemsPerPage;
             const paginatedItems = currentFilteredEvents.slice(startIndex, endIndex);

             // console.log(`Displaying page ${currentPage}/${totalPages}. Items ${startIndex}-${endIndex - 1} of ${currentFilteredEvents.length}. Items/Page: ${itemsPerPage}. Distance Sort Active: ${isDistanceSortActive}`);

             if (currentFilteredEvents.length === 0) {
                 showNoEventsMessage();
                 paginationControlsEl.classList.add('hidden');
             } else if (paginatedItems.length === 0 && currentPage > 1) {
                 console.log("Current page empty, resetting to page 1");
                 currentPage = 1;
                 displayCurrentPage(); // Re-render page 1
             } else {
                 paginatedItems.forEach(event => {
                     if (!event) return;

                     let locationBadgeClass = 'generic-badge';
                     const primaryLocLower = event.location.toLowerCase();
                     if (primaryLocLower.includes('new york') || primaryLocLower.includes('nyc')) locationBadgeClass = 'nyc-badge';
                     else if (primaryLocLower.includes('philadelphia') || primaryLocLower.includes('philly')) locationBadgeClass = 'philly-badge';

                     const distanceText = (isDistanceSortActive && event.distance !== Infinity)
                          ? `<span class="text-xs text-gray-500 ml-auto pl-2 whitespace-nowrap">(${Math.round(event.distance)} km away)</span>` : '';

                     const card = document.createElement('div');
                     card.className = 'event-card relative fade-in';
                     card.innerHTML = `
                         <div class="date-badge z-10">
                             <span class="day">${escapeHTML(String(event.day))}</span>
                             <span class="month">${escapeHTML(event.month)}</span>
                         </div>
                         <div class="event-card-content pt-12"> <div class="flex items-center justify-between mb-2 flex-wrap">
                                 <span class="location-badge ${locationBadgeClass} mr-2">
                                     <i class="fas fa-map-marker-alt mr-1.5 text-xs"></i>${escapeHTML(event.location)}
                                 </span>
                                 ${distanceText} </div>
                             <h3 class="text-lg font-semibold text-gray-800 mb-2 line-clamp-2 hover:text-indigo-600 transition-colors" title="${escapeHTML(event.title)}">
                                 ${escapeHTML(event.title)}
                             </h3>
                             <p class="text-sm text-gray-600 mb-4 line-clamp-3 flex-grow">${escapeHTML(event.description)}</p>
                             <div class="text-xs text-gray-500 mb-4 flex items-center">
                                 <i class="far fa-calendar-alt mr-1.5"></i> ${escapeHTML(event.formattedDate)}
                             </div>
                             <div class="event-card-footer">
                                 <button class="view-details w-full text-center bg-indigo-50 hover:bg-indigo-100 text-indigo-700 text-sm font-medium py-2 px-4 rounded-md transition-colors duration-150 flex items-center justify-center"
                                         data-title="${escapeHTML(event.title)}"
                                         data-date="${escapeHTML(event.formattedDate)}"
                                         data-description="${escapeHTML(event.description)}"
                                         data-location="${escapeHTML(event.location)}"
                                         data-url="${escapeHTML(event.url)}"
                                         data-month="${escapeHTML(event.month)}"
                                         data-day="${escapeHTML(String(event.day))}"
                                         data-start-date-iso="${escapeHTML(formatDateToYyyyMmDd(event.date))}">
                                     View Details <i class="fas fa-arrow-right ml-2 text-xs"></i>
                                 </button>
                             </div>
                         </div>`;
                     eventsContainer.appendChild(card);
                 });

                 updatePaginationControls();
                 paginationControlsEl.classList.remove('hidden');
             }
         }

        function setupDetailButtonListener() {
            if (!eventsContainer) return;
            eventsContainer.addEventListener('click', function(e) {
                const button = e.target.closest('.view-details');
                if (button) {
                    const eventData = {
                        title: button.dataset.title,
                        date: button.dataset.date,
                        description: button.dataset.description,
                        location: button.dataset.location,
                        url: button.dataset.url,
                        month: button.dataset.month,
                        day: button.dataset.day,
                        startDateIso: button.dataset.startDateIso
                    };
                    showEventDetails(eventData);
                }
            });
        }

        function updateEventCount(count) {
             if (eventCountEl) {
                 const categoryName = categories[currentCategory]?.name || 'event';
                 const formattedCount = count.toLocaleString();
                 eventCountEl.innerHTML = `Showing ${formattedCount} ${categoryName} event${count !== 1 ? 's' : ''} matching filters`;
             }
         }

        function showNoEventsMessage(message = null) {
            const defaultMessage = `No ${categories[currentCategory]?.name || 'events'} match your current criteria. Try adjusting filters.`;
            const displayMessage = message || defaultMessage;
             if (noEventsIndicator && noEventsMessage) {
                 noEventsMessage.innerHTML = escapeHTML(displayMessage);
                 noEventsIndicator.classList.remove('hidden');
             }
             if(eventsContainer) eventsContainer.innerHTML = '';
             if(paginationControlsEl) paginationControlsEl.classList.add('hidden');
         }

        function updatePaginationControls() {
             if (!pageInfoEl || !prevPageButton || !nextPageButton) return;
             pageInfoEl.textContent = `Page ${currentPage} of ${totalPages}`;

             prevPageButton.disabled = (currentPage === 1);
             prevPageButton.classList.toggle('disabled:opacity-50', prevPageButton.disabled);
             prevPageButton.classList.toggle('disabled:cursor-not-allowed', prevPageButton.disabled);
             prevPageButton.classList.toggle('disabled:shadow-none', prevPageButton.disabled);

             nextPageButton.disabled = (currentPage >= totalPages);
             nextPageButton.classList.toggle('disabled:opacity-50', nextPageButton.disabled);
             nextPageButton.classList.toggle('disabled:cursor-not-allowed', nextPageButton.disabled);
             nextPageButton.classList.toggle('disabled:shadow-none', nextPageButton.disabled);
         }

        function updateDateRangeDisplay() {
             if (!dateRangeDisplay) return;
             const startDateVal = startDateInput?.value;
             const endDateVal = endDateInput?.value;
             let text = 'All Dates';

             try {
                 const start = startDateVal ? formatDisplayDate(startDateVal) : null;
                 const end = endDateVal ? formatDisplayDate(endDateVal) : null;
                 if (start && end) text = `From ${start} to ${end}`;
                 else if (start) text = `From ${start}`;
                 else if (end) text = `Until ${end}`;
             } catch (e) {
                 console.error("Error formatting date range for display:", e);
                 text = "Invalid Date Range";
             }
             dateRangeDisplay.textContent = text;
         }

        function showEventDetails(eventData) {
             if (!eventData || !eventModal || !modalTitle || !modalContent || !modalLink) return;

             const title = eventData.title || 'Event Details';
             const description = eventData.description || 'No description available.';
             const location = eventData.location || 'Location TBD';
             const formattedDate = eventData.date || 'Date TBD';
             const url = eventData.url;
             const monthShort = eventData.month || '?';
             const dayOfMonth = eventData.day || '?';
             const startDateIso = eventData.startDateIso;

             modalTitle.textContent = escapeHTML(title);
             modalContent.innerHTML = `
                 <div class="space-y-5">
                     <div class="bg-indigo-50 rounded-lg p-4 flex items-start border border-indigo-100">
                         <div class="mr-5 flex-shrink-0">
                             <div class="bg-white rounded-lg shadow p-3 text-center w-16 border border-gray-200">
                                 <div class="text-xs text-indigo-600 uppercase font-semibold tracking-wide">${escapeHTML(monthShort)}</div>
                                 <div class="text-3xl font-bold text-gray-800 mt-1">${escapeHTML(String(dayOfMonth))}</div>
                             </div>
                         </div>
                         <div class="flex-grow mt-1">
                             <div class="text-sm text-gray-600 mb-1 font-medium">${escapeHTML(formattedDate)}</div>
                             <div class="flex items-center text-gray-700">
                                 <i class="fas fa-map-marker-alt mr-2 text-indigo-500 fa-fw"></i>
                                 <span class="font-medium">${escapeHTML(location)}</span>
                             </div>
                         </div>
                     </div>
                     <div>
                         <h4 class="text-lg font-semibold text-gray-800 mb-2">About This Event</h4>
                         <p class="text-gray-700 leading-relaxed whitespace-pre-wrap">${escapeHTML(description)}</p> </div>
                     <div class="bg-blue-50 rounded-lg p-4 border border-blue-100">
                         <div class="flex items-center text-blue-800">
                             <i class="fas fa-info-circle mr-2 fa-fw"></i>
                             <span class="font-medium text-sm">Event Information</span>
                         </div>
                          <p class="text-blue-700 text-sm mt-1.5">This is a ${escapeHTML(categories[currentCategory]?.name || 'curated')} event listed by NoLeaf. Please verify details on the official event website.</p>
                     </div>
                 </div>`;

             if (url) {
                 modalLink.href = url;
                 modalLink.classList.remove('opacity-50', 'cursor-not-allowed');
                 modalLink.setAttribute('target', '_blank');
                 modalLink.style.display = 'inline-flex';
             } else {
                 modalLink.href = '#';
                 modalLink.classList.add('opacity-50', 'cursor-not-allowed');
                 modalLink.removeAttribute('target');
                 modalLink.style.display = 'none';
             }

             if (eventSchemaPlaceholder && startDateIso) {
                 try {
                     const primaryLocation = location.split(';')[0].trim();
                     const eventSchema = {
                         "@context": "https://schema.org",
                         "@type": "Event",
                         "name": title,
                         "startDate": startDateIso,
                         "description": description,
                         "url": url,
                         "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
                         "eventStatus": "https://schema.org/EventScheduled",
                         "location": {
                             "@type": "Place",
                             "name": primaryLocation,
                             "address": primaryLocation
                         }
                     };
                     eventSchemaPlaceholder.textContent = JSON.stringify(eventSchema, null, 2);
                 } catch (e) {
                     console.error("Error generating event schema:", e);
                     eventSchemaPlaceholder.textContent = '';
                 }
             } else {
                 eventSchemaPlaceholder.textContent = '';
             }

             eventModal.classList.remove('hidden');
             closeModalButton.focus();
         }

        function clearEventSchema() {
            if (eventSchemaPlaceholder) eventSchemaPlaceholder.textContent = '';
        }

        // --- Filtering and Sorting Logic ---

        function getActiveLocationFilter() {
            const selectedDropdownValue = locationDropdown?.value;
            if (selectedDropdownValue && selectedDropdownValue !== 'all') {
                return selectedDropdownValue;
            }
            const activeButton = locationFiltersContainer?.querySelector('.filter-button.active');
            return activeButton ? (activeButton.dataset.location || 'all') : 'all';
        }

        function applyFiltersAndDisplay() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const selectedLocationFilter = getActiveLocationFilter();
            const startDateVal = startDateInput?.value;
            const endDateVal = endDateInput?.value;
            const startDate = startDateVal ? getUtcMidnight(parseDate(startDateVal)) : null;
            const endDate = endDateVal ? getUtcMidnight(parseDate(endDateVal)) : null;

            isDistanceSortActive = (selectedLocationFilter === 'all' && userLocation !== null);
            // console.log(`Filtering ${currentCategory}. Search: "${searchTerm}", Location Filter: "${selectedLocationFilter}", Start: ${startDateVal}, End: ${endDateVal}. Distance Sort: ${isDistanceSortActive}`);

            let filtered = allEvents.filter(event => {
                if (!event || !event.date || isNaN(event.date.getTime())) return false;

                const title = event.title || '';
                const description = event.description || '';
                const originalLocation = event.location || '';

                const searchMatch = searchTerm === '' ||
                                    title.toLowerCase().includes(searchTerm) ||
                                    description.toLowerCase().includes(searchTerm) ||
                                    originalLocation.toLowerCase().includes(searchTerm);

                let locationFilterMatch = true;
                if (selectedLocationFilter !== 'all') {
                    const filterLower = selectedLocationFilter.toLowerCase();
                    const majorCityKey = Object.keys(majorCityAliases).find(key => key.toLowerCase() === filterLower);
                    if (majorCityKey) {
                        const aliases = majorCityAliases[majorCityKey];
                        locationFilterMatch = aliases.some(alias => originalLocation.toLowerCase().includes(alias));
                    } else {
                        locationFilterMatch = event.allLocationData.some(locData => {
                            const eventLocLower = `${locData.city}${locData.state ? `, ${locData.state}` : ''}`;
                            return eventLocLower === filterLower;
                        });
                    }
                }

                const eventDateUtc = getUtcMidnight(event.date);
                let dateFilterMatch = true;
                if (eventDateUtc) {
                    const startMatch = !startDate || (eventDateUtc >= startDate);
                    const endMatch = !endDate || (eventDateUtc <= endDate);
                    dateFilterMatch = startMatch && endMatch;
                } else { dateFilterMatch = false; }

                return searchMatch && locationFilterMatch && dateFilterMatch;
            });

            if (isDistanceSortActive) {
                // console.log("Calculating distances for sorting...");
                filtered.forEach(event => {
                    let minDistance = Infinity;
                    event.allLocationData.forEach(locData => {
                        if (locData.coords && userLocation) {
                            const dist = calculateDistance(userLocation.lat, userLocation.lon, locData.coords.lat, locData.coords.lon);
                            if (dist < minDistance) minDistance = dist;
                        }
                    });
                    event.distance = minDistance;
                });
                filtered.sort((a, b) => {
                    if (a.distance !== b.distance) return a.distance - b.distance;
                    return a.date - b.date;
                });
            } else {
                // console.log("Sorting by date only.");
                filtered.sort((a, b) => a.date - b.date);
                filtered.forEach(event => event.distance = Infinity);
            }

            currentFilteredEvents = filtered;
            currentPage = 1;
            displayCurrentPage();
            updateEventCount(currentFilteredEvents.length);
            updateDateRangeDisplay();
        }


        // --- Event Listeners Setup ---

        function setupCategorySwitchers() {
            Object.keys(categories).forEach(key => {
                const button = document.getElementById(categories[key].buttonId);
                if (button) {
                    button.addEventListener('click', () => {
                        if (currentCategory !== key) {
                            console.log(`Switching to category: ${key}`);
                            applyTheme(key);
                            if(searchInput) searchInput.value = '';
                            loadEventsForCategory(); // Reload data
                        }
                    });
                } else { console.error(`Category button not found: ${categories[key].buttonId}`); }
            });
        }

        function setupLocationFilters() {
             if (locationDropdown) {
                 locationDropdown.addEventListener('change', function() {
                     const selectedValue = this.value;
                     locationFiltersContainer?.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
                     if (selectedValue === 'all') {
                         allLocationsFilterButton?.classList.add('active');
                         isDistanceSortActive = userLocation !== null;
                     } else {
                         isDistanceSortActive = false;
                     }
                     applyFiltersAndDisplay();
                 });
             }

             if (locationFiltersContainer) {
                 locationFiltersContainer.addEventListener('click', function(e) {
                     const button = e.target.closest('.filter-button');
                     if (button) {
                         locationFiltersContainer.querySelectorAll('.filter-button').forEach(btn => {
                             if (btn !== button) btn.classList.remove('active');
                         });
                         button.classList.add('active');
                         if (locationDropdown) locationDropdown.value = 'all';
                         isDistanceSortActive = button.id === 'all-locations-filter' && userLocation !== null;
                         // console.log(`Button "${button.dataset.location || 'All'}" clicked. Distance sort: ${isDistanceSortActive}`);
                         applyFiltersAndDisplay();
                     }
                 });
             }
         }

        // --- Initialize Event Listeners ---
        if (searchInput) searchInput.addEventListener('input', applyFiltersAndDisplay);
        if (startDateInput) startDateInput.addEventListener('change', applyFiltersAndDisplay);
        if (endDateInput) endDateInput.addEventListener('change', applyFiltersAndDisplay);

        if (prevPageButton) {
            prevPageButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    displayCurrentPage();
                    eventsContainer?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        }
        if (nextPageButton) {
            nextPageButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    displayCurrentPage();
                     eventsContainer?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        }

        if (closeModalButton && eventModal) {
             closeModalButton.addEventListener('click', () => { eventModal.classList.add('hidden'); clearEventSchema(); });
             eventModal.addEventListener('click', (event) => {
                 if (event.target === eventModal) {
                     eventModal.classList.add('hidden'); clearEventSchema();
                 }
             });
        }

        if (suggestEventButton && suggestModal && closeSuggestModalButton && suggestModalCloseButtonAlt) {
            suggestEventButton.addEventListener('click', () => { suggestModal.classList.remove('hidden'); closeSuggestModalButton.focus(); });
            closeSuggestModalButton.addEventListener('click', () => { suggestModal.classList.add('hidden'); });
            suggestModalCloseButtonAlt.addEventListener('click', () => { suggestModal.classList.add('hidden'); });
            suggestModal.addEventListener('click', (event) => { if (event.target === suggestModal) suggestModal.classList.add('hidden'); });
        } else { console.error("Suggest Event modal elements not found."); }

        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (eventModal && !eventModal.classList.contains('hidden')) { eventModal.classList.add('hidden'); clearEventSchema(); }
                if (suggestModal && !suggestModal.classList.contains('hidden')) suggestModal.classList.add('hidden');
            }
        });

         let resizeTimeout;
         window.addEventListener('resize', () => {
              clearTimeout(resizeTimeout);
              resizeTimeout = setTimeout(() => {
                  // console.log("Window resized, adjusting items per page and re-displaying.");
                  displayCurrentPage();
              }, 250);
         });

        // --- Initial Page Load ---
        console.log("Initializing page...");
        applyTheme(currentCategory); // Apply default theme, UI state, reset location filters
        setDefaultDateRange();     // Set default dates (today to 3 months)
        setupCategorySwitchers();    // Setup category buttons
        setupLocationFilters();      // Setup location filter listeners
        setupDetailButtonListener(); // Setup event delegation for detail buttons ONCE
        getUserLocation();           // Try to get location, which triggers loadEventsForCategory as the final step

    }); // End of DOMContentLoaded
    </script>
</body>
</html>
