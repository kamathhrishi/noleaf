<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoLeaf | Premium Finance & Investment Events</title>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DZNCL3T0ZW"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-DZNCL3T0ZW');
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Apply Inter font globally */
        body { font-family: 'Inter', sans-serif; }

        /* --- Custom Styles --- */

        /* Card Enhancements */
        .event-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .event-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            transform: translateY(-5px) scale(1.01);
        }
        .event-card-content {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .event-card-footer {
             margin-top: auto;
             padding-top: 1rem;
        }

        /* Date Badge */
        .date-badge {
            position: absolute;
            top: 1rem;
            left: -0.5rem;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 0.5rem 0.75rem 0.5rem 1rem;
            border-radius: 0 0.5rem 0.5rem 0;
            font-weight: 600;
            font-size: 0.875rem;
            box-shadow: 0 2px 5px rgba(79, 70, 229, 0.3);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .date-badge .day { font-size: 1.125rem; font-weight: 700; line-height: 1; }
        .date-badge .month { font-size: 0.75rem; line-height: 1; text-transform: uppercase; }

        /* Location Badge */
        .location-badge {
            display: inline-flex;
            align-items: center;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.025em;
            margin-bottom: 0.5rem;
        }
        .nyc-badge { background-color: rgba(59, 130, 246, 0.1); color: #1d4ed8; border: 1px solid rgba(59, 130, 246, 0.3); }
        .philly-badge { background-color: rgba(16, 185, 129, 0.1); color: #047857; border: 1px solid rgba(16, 185, 129, 0.3); }

        /* Header Gradient */
        .gradient-bg { background: linear-gradient(135deg, #1f2937 0%, #111827 100%); }
        .gradient-accent { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); transition: opacity 0.2s ease-in-out; }
        .gradient-accent:hover { opacity: 0.9; }

        /* Logo Text */
        .logo-text { font-weight: 800; letter-spacing: -0.025em; }
        .text-gradient { background: linear-gradient(to right, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* Loading Animation */
        .loading-animate { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        #loading { display: none; }

        /* Line Clamp */
        .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }
        .line-clamp-3 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 3; }

        /* Custom Date Input Styling */
        input[type="date"] { appearance: none; -webkit-appearance: none; position: relative; background-color: white; }
        input[type="date"].custom-date-input {
            border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem 0.75rem;
            font-size: 0.875rem; line-height: 1.25rem; color: #374151;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="date"].custom-date-input:focus {
            outline: none; border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
        }
        input[type="date"].custom-date-input::-webkit-calendar-picker-indicator {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="%236b7280" style="width:1rem; height:1rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" /></svg>') no-repeat center;
            background-size: 1rem 1rem; cursor: pointer; opacity: 0.7; transition: opacity 0.2s ease;
        }
         input[type="date"].custom-date-input::-webkit-calendar-picker-indicator:hover { opacity: 1; }

        /* Modal Scrollbar */
        .modal-content::-webkit-scrollbar { width: 6px; }
        .modal-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb { background: #a5b4fc; border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb:hover { background: #818cf8; }

        /* Fade In Animation */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Filter Buttons */
        .filter-button {
            transition: all 0.2s ease-in-out; padding: 0.5rem 1rem; border-radius: 9999px;
            font-size: 0.875rem; font-weight: 500; border: 1px solid transparent;
        }
        .filter-button.active { background-color: #4f46e5; color: white; box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2); }
        .filter-button:not(.active) { background-color: #e5e7eb; color: #374151; border-color: #d1d5db; }
        .filter-button:not(.active):hover { background-color: #d1d5db; border-color: #9ca3af; }

        /* Suggestion Modal Specific Styles */
        #suggest-modal .modal-content { /* No specific styles needed currently */ }

    </style>
</head>
<body class="bg-gray-100"> <input type="file" id="csv-file" accept=".csv" class="hidden">

    <header class="gradient-bg text-white">
        <div class="container mx-auto px-4 py-16 md:py-24 text-center">
            <div class="mb-4">
                <div class="inline-flex items-center justify-center mb-2">
                    <span class="text-4xl md:text-5xl logo-text text-gradient">NoLeaf</span>
                    <span class="bg-indigo-500 text-white text-xs font-bold px-2.5 py-1 rounded-full ml-3 uppercase tracking-wider shadow-md">Beta</span>
                </div>
                 <p class="text-xs text-gray-400">
                    Developed by <a href="https://kamathhrishi.github.io/" target="_blank" rel="noopener noreferrer" class="hover:text-indigo-300 transition-colors underline decoration-dotted">Hrishikesh Kamath</a>
                </p>
            </div>
            <h1 class="text-3xl md:text-5xl font-bold mb-4 leading-tight max-w-3xl mx-auto">Discover Premium Finance & Investment Events</h1>
            <p class="text-lg md:text-xl text-gray-300 mb-8 max-w-2xl mx-auto">Your curated guide to top-tier conferences and networking opportunities in NYC & Philadelphia.</p>
            <div class="flex flex-wrap gap-4 justify-center">
                <a href="#events-section" class="gradient-accent text-white font-medium rounded-lg px-6 py-3 inline-flex items-center transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    <i class="fas fa-calendar-alt mr-2"></i> Browse Events
                </a>
                <button id="suggest-event-button" class="bg-gray-700 hover:bg-gray-600 text-white font-medium rounded-lg px-6 py-3 inline-flex items-center transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                    <i class="fas fa-plus-circle mr-2"></i> Missing event? Let us know
                </button>
            </div>
        </div>
    </header>

    <section class="bg-white/95 backdrop-blur-sm border-b border-gray-200 shadow-sm md:sticky md:top-0 md:z-20">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row md:items-center gap-4">
                <div class="flex items-center justify-center md:justify-start gap-2 flex-shrink-0">
                    <button id="all-filter" class="filter-button active">All</button>
                    <button id="nyc-filter" class="filter-button">New York</button>
                    <button id="philly-filter" class="filter-button">Philadelphia</button>
                </div>
                <div class="relative flex-grow md:max-w-xs w-full">
                    <input type="text" id="search-input" placeholder="Search events..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    <i class="fas fa-search absolute left-3.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
                <div class="flex flex-col sm:flex-row items-center justify-center sm:justify-end gap-x-3 gap-y-2 w-full md:w-auto md:ml-auto">
                    <label for="start-date" class="text-sm font-medium text-gray-600 flex-shrink-0 whitespace-nowrap">Date From:</label>
                    <input type="date" id="start-date" class="custom-date-input w-full sm:w-auto">
                    <label for="end-date" class="text-sm font-medium text-gray-600 ml-0 sm:ml-1 flex-shrink-0 whitespace-nowrap">To:</label>
                    <input type="date" id="end-date" class="custom-date-input w-full sm:w-auto">
                </div>
            </div>
        </div>
    </section>

    <section id="events-section" class="py-12 md:py-16">
        <div class="container mx-auto px-4">
            <div class="mb-10 md:flex justify-between items-center">
                 <div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-1">Upcoming Events</h2>
                    <div id="event-count" class="text-gray-600">Loading events...</div>
                 </div>
                 <div id="current-date-range" class="flex items-center text-sm text-gray-500 mt-2 md:mt-0 bg-gray-200 px-3 py-1.5 rounded-full">
                    <i class="far fa-calendar-alt mr-2 text-gray-600"></i>
                    <span id="date-range-display">All Dates</span>
                 </div>
            </div>

            <div id="loading" class="loading-animate text-center py-16">
                <div class="inline-block p-8 bg-white rounded-lg shadow-md">
                    <i class="fas fa-spinner fa-spin text-5xl text-indigo-500 mb-4"></i>
                    <p class="text-gray-700 text-lg font-medium">Loading Events</p>
                    <p class="text-gray-500 text-sm mt-1">Fetching the latest event data...</p>
                </div>
            </div>

            <div id="events-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                </div>

            <div id="no-events" class="hidden text-center py-16 bg-white rounded-lg shadow-sm mt-8">
                <i class="fas fa-calendar-times text-6xl text-gray-300 mb-5"></i>
                <p id="no-events-message" class="text-gray-700 text-xl font-semibold">No events found.</p>
                <p class="text-gray-500 mt-2">Try adjusting your search terms or date filters.</p>
            </div>

            <div id="pagination-controls" class="flex justify-center items-center space-x-3 md:space-x-4 mt-10 mb-4 hidden">
                <button id="prev-page" class="bg-white hover:bg-gray-100 border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center shadow-sm disabled:shadow-none">
                    <i class="fas fa-chevron-left mr-2 text-xs"></i> Prev
                </button>
                <span id="page-info" class="text-gray-600 text-sm font-medium px-2">Page 1 of 1</span>
                <button id="next-page" class="bg-white hover:bg-gray-100 border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center shadow-sm disabled:shadow-none">
                    Next <i class="fas fa-chevron-right ml-2 text-xs"></i>
                </button>
            </div>
        </div>
    </section>

    <footer class="bg-gray-800 text-white py-12">
        <div class="container mx-auto px-4 text-center">
            <div class="mb-6">
                <div class="inline-flex items-center justify-center mb-2">
                     <span class="text-2xl font-bold logo-text text-gradient">NoLeaf</span>
                </div>
                <p class="text-gray-400 max-w-lg mx-auto text-sm">
                    Your premier destination for discovering top finance and investment events in NYC and Philadelphia. Stay ahead of the curve.
                </p>
            </div>
             <div class="mt-8 pt-8 border-t border-gray-700">
                <p class="text-gray-500 text-sm">&copy; 2025 NoLeaf. All rights reserved. | <a href="#" class="hover:text-indigo-300">Privacy Policy</a></p>
            </div>
        </div>
    </footer>

    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden p-4 fade-in">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="p-5 md:p-6 flex justify-between items-center border-b border-gray-200 bg-gray-50">
                <h3 id="modal-title" class="text-xl md:text-2xl font-semibold text-gray-800 pr-4 leading-tight">Event Title Placeholder</h3>
                <button id="close-modal" class="text-gray-400 hover:text-red-600 transition-colors rounded-full p-1 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modal-content" class="p-5 md:p-8 overflow-y-auto modal-content flex-grow space-y-6">
                </div>
            <div class="p-5 md:p-6 border-t border-gray-200 bg-gray-50 flex justify-end">
                <a id="modal-link" href="#" target="_blank" rel="noopener noreferrer" class="gradient-accent hover:opacity-90 text-white font-medium rounded-lg px-6 py-2.5 inline-flex items-center transition-all shadow hover:shadow-md transform hover:-translate-y-0.5">
                    View Event Website <i class="fas fa-external-link-alt ml-2 text-xs"></i>
                </a>
            </div>
        </div>
    </div>

    <div id="suggest-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden p-4 fade-in">
        <div class="bg-white rounded-xl max-w-lg w-full max-h-[90vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="p-5 md:p-6 flex justify-between items-center border-b border-gray-200 bg-gray-50">
                <h3 class="text-xl font-semibold text-gray-800 pr-4 leading-tight flex items-center">
                    <i class="fas fa-lightbulb mr-3 text-yellow-500"></i> Suggest an Event
                </h3>
                <button id="close-suggest-modal" class="text-gray-400 hover:text-red-600 transition-colors rounded-full p-1 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-5 md:p-8 overflow-y-auto modal-content flex-grow space-y-4">
                 <p class="text-gray-700 leading-relaxed">
                    Know of a great finance or investment event in NYC or Philadelphia that we missed? We'd love to hear about it!
                 </p>
                 <p class="text-gray-700 leading-relaxed">
                    Please send the event details (name, date, location, website link) to:
                 </p>
                 <div class="bg-indigo-50 border border-indigo-200 rounded-md p-3 text-center">
                     <a href="mailto:kamathhrishi@gmail.com" class="text-indigo-700 font-medium hover:text-indigo-900 hover:underline break-all">
                         <i class="fas fa-envelope mr-2"></i>kamathhrishi@gmail.com
                     </a>
                 </div>
                 <p class="text-sm text-gray-500 mt-3">
                    We'll review your suggestion and add it if it fits our criteria. Thanks for helping keep NoLeaf up-to-date!
                 </p>
            </div>
            <div class="p-4 md:p-5 border-t border-gray-200 bg-gray-50 flex justify-end">
                 <button id="suggest-modal-close-button-alt" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg px-5 py-2 transition-colors">
                    Close
                 </button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Global State ---
            let allEvents = [];
            let currentFilteredEvents = [];
            let currentPage = 1;
            let totalPages = 1;
            let itemsPerPage = 9; // Default items per page (will be adjusted)

            // --- Configuration ---
            const eventsUrl = 'https://raw.githubusercontent.com/kamathhrishi/noleaf/main/events.csv';

            // --- DOM Elements ---
            const eventsContainer = document.getElementById('events-container');
            const loadingIndicator = document.getElementById('loading');
            const noEventsIndicator = document.getElementById('no-events');
            const noEventsMessage = document.getElementById('no-events-message');
            const eventCountEl = document.getElementById('event-count');
            const paginationControlsEl = document.getElementById('pagination-controls');
            const prevPageButton = document.getElementById('prev-page');
            const nextPageButton = document.getElementById('next-page');
            const pageInfoEl = document.getElementById('page-info');
            const searchInput = document.getElementById('search-input');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const dateRangeDisplay = document.getElementById('date-range-display');
            const eventModal = document.getElementById('event-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalLink = document.getElementById('modal-link');
            const closeModalButton = document.getElementById('close-modal');
            const suggestEventButton = document.getElementById('suggest-event-button');
            const suggestModal = document.getElementById('suggest-modal');
            const closeSuggestModalButton = document.getElementById('close-suggest-modal');
            const suggestModalCloseButtonAlt = document.getElementById('suggest-modal-close-button-alt');
            const allFilterButton = document.getElementById('all-filter');
            const nycFilterButton = document.getElementById('nyc-filter');
            const phillyFilterButton = document.getElementById('philly-filter');

            // --- Helper Functions ---
            function formatDateToYyyyMmDd(date) {
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // --- Core Logic ---
            function setDefaultDateRange() {
                const today = new Date(); // Get today's date
                const oneMonthFromToday = new Date(today);
                oneMonthFromToday.setMonth(today.getMonth() + 1); // Add one month

                const defaultStartDateStr = formatDateToYyyyMmDd(today);
                const defaultEndDateStr = formatDateToYyyyMmDd(oneMonthFromToday); // Format the date one month from today

                if (startDateInput) {
                    startDateInput.value = defaultStartDateStr;
                    console.log("Default start date set to:", defaultStartDateStr);
                }
                if (endDateInput) {
                    endDateInput.value = defaultEndDateStr;
                    console.log("Default end date set to:", defaultEndDateStr);
                }
                updateDateRangeDisplay(); // Update the text display
            }


            function loadFromCSV(csvUrl) {
                console.log("Loading CSV from:", csvUrl);
                loadingIndicator.style.display = 'block';
                eventsContainer.innerHTML = '';
                noEventsIndicator.classList.add('hidden');
                paginationControlsEl.classList.add('hidden');
                eventCountEl.textContent = 'Loading events...';
                Papa.parse(csvUrl, {
                    download: true, header: true, skipEmptyLines: true,
                    complete: handleParsedData,
                    error: (err) => { handleCSVError("Could not fetch or parse event data."); }
                });
            }

            function handleParsedData(results) {
                try {
                    loadingIndicator.style.display = 'none';
                    if (results.data && results.data.length > 0) {
                        allEvents = processEvents(results.data);
                        console.log(`Processed ${allEvents.length} valid events with links.`);
                        currentFilteredEvents = [...allEvents];
                        currentPage = 1;
                        setDefaultDateRange(); // Set default dates first
                        applyFiltersAndDisplay(); // Then filter and display
                        setActiveFilter(allFilterButton);
                    } else if (results.errors && results.errors.length > 0) {
                        console.error("CSV Parsing Errors:", results.errors);
                        handleCSVError("Error parsing CSV data.");
                    } else {
                        setDefaultDateRange(); // Still set dates even if no events
                        showNoEventsMessage("No event data found.");
                        updateEventCount(0);
                    }
                } catch (error) {
                    console.error("Error in handleParsedData:", error);
                    handleCSVError("Error processing event data.");
                }
            }

            function handleCSVError(message = "Could not load events.") {
                loadingIndicator.style.display = 'none';
                try { setDefaultDateRange(); } catch(e) { console.error("Error setting default dates during CSV error handling:", e); }
                showNoEventsMessage(message);
                updateEventCount(0);
                paginationControlsEl.classList.add('hidden');
            }

            function processEvents(data) {
                console.log("Processing raw data rows:", data.length);
                if (!(data.length > 0 && data[0])) return [];
                console.log("CSV Headers found:", Object.keys(data[0]));
                const dateRangeColumn = "Event date is between April 1, 2025, and August 31, 2025"; // This column might need adjustment if the source data changes
                const noCryptoColumn = "Event does not focus on crypto or web3 topics";
                const locationColumn = "Event is located in New York City or Philadelphia";
                const financeColumn = "Event is related to finance or investing";
                const dateCol = "Event Date";
                const titleCol = "Event Name";
                const descCol = "Description";
                const urlCol = "Event Website";
                const locCol = "Event Location";
                const authorCol = "Author";

                const processed = data
                    .filter((event) => { // Initial flag filtering
                        // Keep the original date range check for initial CSV filtering if needed,
                        // but the default display range is handled separately now.
                        // const dateInRange = String(event[dateRangeColumn] || '').trim().toUpperCase() === "YES";
                        const notCrypto = String(event[noCryptoColumn] || '').trim().toUpperCase() === "YES";
                        const correctLocation = String(event[locationColumn] || '').trim().toUpperCase() === "YES";
                        const financeRelated = String(event[financeColumn] || '').trim().toUpperCase() === "YES";
                        // return dateInRange && notCrypto && correctLocation && financeRelated;
                        // Removed dateInRange check here as default range is handled later
                         return notCrypto && correctLocation && financeRelated;
                    })
                    .map((event) => { // Mapping and link/date validation
                        let eventDate = parseDate(event[dateCol]);
                        if (isNaN(eventDate.getTime())) return null; // Invalid date
                        const url = String(event[urlCol] || '').trim();
                        if (!url || url === '#') return null; // Invalid link

                        return {
                            title: String(event[titleCol] || 'Untitled Event').trim(),
                            description: String(event[descCol] || 'No description.').trim(),
                            url: url,
                            date: eventDate,
                            formattedDate: formatDate(eventDate),
                            shortDate: formatShortDate(eventDate),
                            location: String(event[locCol] || 'Location TBD').trim(),
                            author: String(event[authorCol] || '').trim(),
                            month: eventDate.toLocaleString('default', { month: 'short', timeZone: 'UTC' }),
                            day: eventDate.getUTCDate()
                        };
                    })
                    .filter(event => event !== null) // Remove invalid entries
                    .sort((a, b) => a.date - b.date); // Sort by date

                console.log("Finished processing. Valid events with links:", processed.length);
                return processed;
            }

            function displayCurrentPage() {
                eventsContainer.innerHTML = '';
                noEventsIndicator.classList.add('hidden');

                // *** Adjust itemsPerPage based on screen width ***
                const screenWidth = window.innerWidth;
                if (screenWidth < 640) { // Tailwind's 'sm' breakpoint
                    itemsPerPage = 3; // ** Changed from 4 to 3 for small screens **
                } else if (screenWidth < 1024) { // Tailwind's 'lg' breakpoint
                    itemsPerPage = 8;
                } else {
                    itemsPerPage = 9;
                }
                // ************************************************

                totalPages = Math.max(1, Math.ceil(currentFilteredEvents.length / itemsPerPage));
                currentPage = Math.max(1, Math.min(currentPage, totalPages));
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const paginatedItems = currentFilteredEvents.slice(startIndex, endIndex);

                console.log(`Displaying page ${currentPage}/${totalPages}. Items ${startIndex}-${endIndex - 1} (PerPage: ${itemsPerPage})`);

                if (currentFilteredEvents.length === 0) {
                    showNoEventsMessage("No events match your current criteria.");
                    paginationControlsEl.classList.add('hidden');
                } else if (paginatedItems.length === 0 && currentPage > 1) {
                    currentPage--;
                    displayCurrentPage(); // Re-render previous page
                } else {
                    paginatedItems.forEach(event => {
                        if (!event) return;
                        let locationBadge = '';
                        const locLower = event.location.toLowerCase();
                        if (locLower.includes('new york') || locLower.includes('nyc')) {
                            locationBadge = '<span class="location-badge nyc-badge"><i class="fas fa-map-marker-alt mr-1.5 text-xs"></i>NYC</span>';
                        } else if (locLower.includes('philadelphia') || locLower.includes('philly')) {
                            locationBadge = '<span class="location-badge philly-badge"><i class="fas fa-map-marker-alt mr-1.5 text-xs"></i>Philadelphia</span>';
                        } else if (event.location && event.location !== 'Location TBD') {
                             locationBadge = `<span class="location-badge bg-gray-100 text-gray-600 border border-gray-300"><i class="fas fa-map-marker-alt mr-1.5 text-xs"></i>${escapeHTML(event.location)}</span>`;
                        }
                        const card = document.createElement('div');
                        card.className = 'event-card relative fade-in';
                        card.innerHTML = `
                            <div class="date-badge z-10">
                                <span class="day">${escapeHTML(String(event.day))}</span>
                                <span class="month">${escapeHTML(event.month)}</span>
                            </div>
                            <div class="event-card-content pt-12"> ${locationBadge}
                                <h3 class="text-lg font-semibold text-gray-800 mb-2 line-clamp-2 hover:text-indigo-600 transition-colors" title="${escapeHTML(event.title)}">
                                    ${escapeHTML(event.title)}
                                </h3>
                                <p class="text-sm text-gray-600 mb-4 line-clamp-3 flex-grow">${escapeHTML(event.description)}</p>
                                <div class="text-xs text-gray-500 mb-4 flex items-center">
                                     <i class="far fa-calendar-alt mr-1.5"></i> ${escapeHTML(event.formattedDate)}
                                </div>
                                <div class="event-card-footer">
                                    <button class="view-details w-full text-center bg-indigo-50 hover:bg-indigo-100 text-indigo-700 text-sm font-medium py-2 px-4 rounded-md transition-colors duration-150 flex items-center justify-center"
                                            data-title="${escapeHTML(event.title)}" data-date="${escapeHTML(event.formattedDate)}"
                                            data-description="${escapeHTML(event.description)}" data-location="${escapeHTML(event.location)}"
                                            data-url="${escapeHTML(event.url)}" data-month="${escapeHTML(event.month)}"
                                            data-day="${escapeHTML(String(event.day))}">
                                        View Details <i class="fas fa-arrow-right ml-2 text-xs"></i>
                                    </button>
                                </div>
                            </div>`;
                        eventsContainer.appendChild(card);
                    });
                    addDetailButtonListeners();
                    updatePaginationControls();
                    paginationControlsEl.classList.remove('hidden');
                }
            }

            function addDetailButtonListeners() {
                eventsContainer.querySelectorAll('.view-details').forEach(button => {
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);
                    newButton.addEventListener('click', function() {
                        const eventData = {
                            title: this.dataset.title, date: this.dataset.date, description: this.dataset.description,
                            location: this.dataset.location, url: this.dataset.url, month: this.dataset.month, day: this.dataset.day
                        };
                        showEventDetails(eventData);
                    });
                });
            }

            function escapeHTML(str) {
                if (typeof str !== 'string') return str;
                return str.replace(/[&<>"']/g, match => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[match]);
            }

            function updateEventCount(count) {
                if (eventCountEl) eventCountEl.textContent = `Showing ${count} event${count !== 1 ? 's' : ''}`;
            }

            function showNoEventsMessage(message = "No events found.") {
                if (noEventsIndicator && noEventsMessage) {
                    noEventsMessage.textContent = escapeHTML(message);
                    noEventsIndicator.classList.remove('hidden');
                }
                eventsContainer.innerHTML = '';
                paginationControlsEl.classList.add('hidden');
            }

            function updatePaginationControls() {
                if (!pageInfoEl || !prevPageButton || !nextPageButton) return;
                pageInfoEl.textContent = `Page ${currentPage} of ${totalPages}`;
                prevPageButton.disabled = (currentPage === 1);
                nextPageButton.disabled = (currentPage >= totalPages);
                prevPageButton.classList.toggle('disabled:opacity-50', prevPageButton.disabled);
                prevPageButton.classList.toggle('disabled:cursor-not-allowed', prevPageButton.disabled);
                nextPageButton.classList.toggle('disabled:opacity-50', nextPageButton.disabled);
                nextPageButton.classList.toggle('disabled:cursor-not-allowed', nextPageButton.disabled);
            }

            function updateDateRangeDisplay() {
                if (!dateRangeDisplay) return;
                const startDateVal = startDateInput?.value; const endDateVal = endDateInput?.value;
                let text = 'All Dates';
                try {
                    const start = startDateVal ? formatDisplayDate(startDateVal) : null;
                    const end = endDateVal ? formatDisplayDate(endDateVal) : null;
                    if (start && end) text = `From ${start} to ${end}`;
                    else if (start) text = `From ${start}`;
                    else if (end) text = `Until ${end}`;
                } catch (e) { text = "Invalid Date Range"; }
                dateRangeDisplay.textContent = text;
            }

            function formatDisplayDate(dateStr) {
                 if (!dateStr) return null;
                 const parts = dateStr.split('-');
                 if (parts.length !== 3) return null;
                 const year = parseInt(parts[0], 10); const month = parseInt(parts[1], 10) - 1; const day = parseInt(parts[2], 10);
                 const date = new Date(Date.UTC(year, month, day));
                 if (!isNaN(date.getTime())) {
                     const displayMonth = date.toLocaleString('en-US', { month: 'short', timeZone: 'UTC' });
                     const displayDay = date.getUTCDate(); const displayYear = date.getUTCFullYear();
                     return `${displayMonth} ${displayDay}, ${displayYear}`;
                 } return null;
            }

            function getUtcMidnight(date) {
                if (!date || isNaN(date.getTime())) return null;
                return new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
            }

            function parseDate(dateStr) {
                if (typeof dateStr !== 'string' || !dateStr) return new Date(NaN);
                let date = new Date(NaN); const trimmedDateStr = dateStr.trim();
                if (/^\d{4}-\d{2}-\d{2}$/.test(trimmedDateStr)) date = new Date(trimmedDateStr + 'T00:00:00Z');
                if (isNaN(date.getTime()) && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(trimmedDateStr)) {
                    const parts = trimmedDateStr.split('/'); date = new Date(Date.UTC(parts[2], parts[0] - 1, parts[1]));
                }
                return isNaN(date.getTime()) ? new Date(NaN) : date;
            }

            function formatDate(date) {
                if (!date || isNaN(date.getTime())) return "Invalid Date";
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' };
                try { return date.toLocaleDateString('en-US', options); } catch (e) { return "Invalid Date"; }
            }

            function formatShortDate(date) {
                if (!date || isNaN(date.getTime())) return "N/A";
                const options = { month: 'short', day: 'numeric', timeZone: 'UTC' };
                try { return date.toLocaleDateString('en-US', options); } catch (e) { return "N/A"; }
            }

            function showEventDetails(eventData) {
                if (!eventData) return;
                const title = eventData.title || 'Event Details';
                const description = eventData.description || 'No description.';
                const location = eventData.location || 'Location TBD';
                const formattedDate = eventData.date || 'Date TBD';
                const url = eventData.url;
                const monthShort = eventData.month || '?';
                const dayOfMonth = eventData.day || '?';

                modalTitle.textContent = title;
                modalContent.innerHTML = `
                    <div class="space-y-5">
                        <div class="bg-indigo-50 rounded-lg p-4 flex items-start border border-indigo-100">
                            <div class="mr-5 flex-shrink-0"> <div class="bg-white rounded-lg shadow p-3 text-center w-16 border border-gray-200"> <div class="text-xs text-indigo-600 uppercase font-semibold tracking-wide">${escapeHTML(monthShort)}</div> <div class="text-3xl font-bold text-gray-800 mt-1">${escapeHTML(String(dayOfMonth))}</div> </div> </div>
                            <div class="flex-grow mt-1"> <div class="text-sm text-gray-600 mb-1 font-medium">${escapeHTML(formattedDate)}</div> <div class="flex items-center text-gray-700"> <i class="fas fa-map-marker-alt mr-2 text-indigo-500 fa-fw"></i> <span class="font-medium">${escapeHTML(location)}</span> </div> </div>
                        </div>
                        <div> <h4 class="text-lg font-semibold text-gray-800 mb-2">About This Event</h4> <p class="text-gray-700 leading-relaxed whitespace-pre-wrap">${escapeHTML(description)}</p> </div>
                        <div class="bg-blue-50 rounded-lg p-4 border border-blue-100"> <div class="flex items-center text-blue-800"> <i class="fas fa-info-circle mr-2 fa-fw"></i> <span class="font-medium text-sm">Event Information</span> </div> <p class="text-blue-700 text-sm mt-1.5">This is a premium finance & investment event curated by NoLeaf.</p> </div>
                    </div>`;
                modalLink.href = url;
                modalLink.classList.remove('opacity-50', 'cursor-not-allowed');
                modalLink.setAttribute('target', '_blank');
                eventModal.classList.remove('hidden');
                closeModalButton.focus();
            }
            closeModalButton.addEventListener('click', () => eventModal.classList.add('hidden'));
            eventModal.addEventListener('click', (event) => { if (event.target === eventModal) eventModal.classList.add('hidden'); });

            if (suggestEventButton && suggestModal && closeSuggestModalButton && suggestModalCloseButtonAlt) {
                suggestEventButton.addEventListener('click', () => { suggestModal.classList.remove('hidden'); closeSuggestModalButton.focus(); });
                closeSuggestModalButton.addEventListener('click', () => { suggestModal.classList.add('hidden'); });
                suggestModalCloseButtonAlt.addEventListener('click', () => { suggestModal.classList.add('hidden'); });
                suggestModal.addEventListener('click', (event) => { if (event.target === suggestModal) suggestModal.classList.add('hidden'); });
            } else { console.error("Suggest Event modal elements not found."); }

            function setActiveFilter(activeButton) {
                 [allFilterButton, nycFilterButton, phillyFilterButton].forEach(button => button.classList.remove('active'));
                 if (activeButton) activeButton.classList.add('active');
            }

            function applyFiltersAndDisplay() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const activeFilterButton = document.querySelector('.filter-button.active');
                let currentFilter = 'all';
                if (activeFilterButton) {
                    if (activeFilterButton.id === 'nyc-filter') currentFilter = 'nyc';
                    else if (activeFilterButton.id === 'philly-filter') currentFilter = 'philly';
                }
                const startDateVal = startDateInput?.value; const endDateVal = endDateInput?.value;
                const startDate = startDateVal ? getUtcMidnight(parseDate(startDateVal)) : null;
                const endDate = endDateVal ? getUtcMidnight(parseDate(endDateVal)) : null;
                console.log("Filtering with StartDate:", startDate, "EndDate:", endDate);

                currentFilteredEvents = allEvents.filter(event => {
                    const title = event.title || ''; const description = event.description || ''; const location = event.location || '';
                    const searchMatch = searchTerm === '' || title.toLowerCase().includes(searchTerm) || description.toLowerCase().includes(searchTerm) || location.toLowerCase().includes(searchTerm);
                    let locationFilterMatch = true;
                    const locLower = location.toLowerCase();
                    if (currentFilter === 'nyc') locationFilterMatch = locLower.includes('new york') || locLower.includes('nyc');
                    else if (currentFilter === 'philly') locationFilterMatch = locLower.includes('philadelphia') || locLower.includes('philly');
                    const eventDateUtc = getUtcMidnight(event.date);
                    let dateFilterMatch = true;
                    if (eventDateUtc) {
                         const startMatch = !startDate || (eventDateUtc >= startDate);
                         const endMatch = !endDate || (eventDateUtc <= endDate);
                         dateFilterMatch = startMatch && endMatch;
                    } else dateFilterMatch = false;
                    return searchMatch && locationFilterMatch && dateFilterMatch;
                });

                currentPage = 1;
                displayCurrentPage(); // This now uses the responsive itemsPerPage
                updateEventCount(currentFilteredEvents.length);
                updateDateRangeDisplay();
            }

            // --- Event Listeners Setup ---
            searchInput.addEventListener('input', applyFiltersAndDisplay);
            allFilterButton.addEventListener('click', function() { setActiveFilter(this); applyFiltersAndDisplay(); });
            nycFilterButton.addEventListener('click', function() { setActiveFilter(this); applyFiltersAndDisplay(); });
            phillyFilterButton.addEventListener('click', function() { setActiveFilter(this); applyFiltersAndDisplay(); });
            prevPageButton.addEventListener('click', () => { if (currentPage > 1) { currentPage--; displayCurrentPage(); window.scrollTo({ top: eventsContainer.offsetTop - 80, behavior: 'smooth' }); } });
            nextPageButton.addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; displayCurrentPage(); window.scrollTo({ top: eventsContainer.offsetTop - 80, behavior: 'smooth' }); } });
            if (startDateInput) startDateInput.addEventListener('change', applyFiltersAndDisplay);
            if (endDateInput) endDateInput.addEventListener('change', applyFiltersAndDisplay);

             window.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    if (!eventModal.classList.contains('hidden')) eventModal.classList.add('hidden');
                    if (!suggestModal.classList.contains('hidden')) suggestModal.classList.add('hidden');
                }
             });

            // Resize listener to re-render page with correct itemsPerPage
             let resizeTimeout;
             window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    console.log("Window resized, adjusting items per page and re-displaying.");
                    // No need to re-filter, just re-display the current page
                    displayCurrentPage();
                }, 250); // Debounce resize event
             });

            // --- Initial Load ---
            loadFromCSV(eventsUrl);

        }); // End of DOMContentLoaded
    </script>
</body>
</html>
