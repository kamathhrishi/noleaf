<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y90Q1DKJCC"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-Y90Q1DKJCC');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>NoLeaf | The Most Exhaustive Finance, AI & Cybersecurity Event List (USA)</title>
    <meta name="description" content="The most exhaustive list of Finance, AI, and Cybersecurity conferences, seminars, and networking events across the United States (NYC, Philly, SF Bay Area, Seattle, Austin, Boston & more). Explore 1800+ events curated by NoLeaf.">
    <link rel="canonical" href="https://noleaf.app/event-finder/" />

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://noleaf.app/event-finder/">
    <meta property="og:title" content="NoLeaf | The Most Exhaustive Finance, AI & Cybersecurity Event List (USA)">
    <meta property="og:description" content="The most exhaustive list of Finance, AI, and Cybersecurity conferences, seminars, and networking events across the United States. Explore 1800+ events curated by NoLeaf.">
    <meta property="og:image" content="https://noleaf.app/images/noleaf-social-preview.jpg">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://noleaf.app/event-finder/">
    <meta property="twitter:title" content="NoLeaf | The Most Exhaustive Finance, AI & Cybersecurity Event List (USA)">
    <meta property="twitter:description" content="The most exhaustive list of Finance, AI, and Cybersecurity conferences, seminars, and networking events across the United States. Explore 1800+ events curated by NoLeaf.">
    <meta property="twitter:image" content="https://noleaf.app/images/noleaf-social-preview.jpg">

    <script type="application/ld+json" id="website-schema">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "NoLeaf Event Finder",
      "url": "https://noleaf.app/",
      "description": "The most exhaustive list of Finance, AI, and Cybersecurity events across the United States.",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://noleaf.app/",
        "query-input": "required name=search_term_string"
      }
    }
    </script>
    <script type="application/ld+json" id="event-schema-placeholder"></script>


    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Apply body theme classes (will be added/removed by JS) */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease; /* Smooth theme transition */
            background-color: #f3f4f6; /* Default background */
            -webkit-font-smoothing: antialiased; /* Improve font rendering */
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Custom Styles --- */

        /* Card Enhancements */
        .event-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%; /* Ensure cards in a row take same height */
        }
        .event-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            transform: translateY(-5px) scale(1.01);
        }
        .event-card-content {
            padding: 1.5rem;
            flex-grow: 1; /* Allow content to grow */
            display: flex;
            flex-direction: column;
        }
        .event-card-footer {
             margin-top: auto; /* Push footer to bottom */
             padding-top: 1rem;
        }

        /* Date Badge */
        .date-badge {
            position: absolute;
            top: 1rem;
            left: -0.5rem;
            /* Background set by theme */
            color: white;
            padding: 0.5rem 0.75rem 0.5rem 1rem;
            border-radius: 0 0.5rem 0.5rem 0;
            font-weight: 600;
            font-size: 0.875rem;
            /* Box shadow set by theme */
            display: flex;
            align-items: center;
            gap: 0.25rem;
            z-index: 10; /* Ensure badge is above content */
        }
        .date-badge .day { font-size: 1.125rem; font-weight: 700; line-height: 1; }
        .date-badge .month { font-size: 0.75rem; line-height: 1; text-transform: uppercase; }

        /* Location Badge */
        .location-badge {
            display: inline-flex;
            align-items: center;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.025em;
            margin-bottom: 0.5rem;
        }
        /* Specific City Badges */
        .nyc-badge { background-color: rgba(59, 130, 246, 0.1); color: #1d4ed8; border: 1px solid rgba(59, 130, 246, 0.3); }
        .philly-badge { background-color: rgba(16, 185, 129, 0.1); color: #047857; border: 1px solid rgba(16, 185, 129, 0.3); }
        /* Generic Badge (used for tech hubs for now, can be customized) */
        .generic-badge { background-color: #e5e7eb; color: #374151; border: 1px solid #d1d5db; }


        /* Header Gradient & Accent (Set by theme) */
        .gradient-bg { transition: background 0.3s ease; }
        .gradient-accent { transition: background 0.3s ease, opacity 0.2s ease-in-out; }
        .gradient-accent:hover { opacity: 0.9; }

        /* Logo Text & Gradient (Set by theme) */
        .logo-text { font-weight: 800; letter-spacing: -0.025em; }
        .text-gradient { transition: background 0.3s ease; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* *** UPDATED Headline Styling for Responsiveness *** */
        .headline-logo {
            font-size: 3.75rem; /* text-6xl - Base size for mobile */
            line-height: 1;
            display: block;
            margin-bottom: 0.5rem;
        }
        .headline-description {
            font-size: 1.25rem; /* text-xl - Base size for mobile */
            line-height: 1.75rem; /* leading-7 */
            font-weight: 600; /* semibold */
            display: block;
            color: #d1d5db; /* Lighter text color (gray-400) */
        }
        /* Responsive adjustments */
        @media (min-width: 640px) { /* sm breakpoint */
            .headline-logo {
                font-size: 4.5rem; /* text-7xl */
                margin-bottom: 0.75rem;
            }
             .headline-description {
                font-size: 1.5rem; /* text-2xl */
                line-height: 2rem; /* leading-8 */
            }
        }
        @media (min-width: 1024px) { /* lg breakpoint */
            .headline-logo {
                font-size: 6rem; /* text-9xl */
                margin-bottom: 1rem;
            }
            .headline-description {
                font-size: 1.875rem; /* text-3xl */
                line-height: 2.25rem; /* leading-9 */
            }
        }


        /* Loading Animation */
        .loading-animate { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        #loading { display: none; }
        #loading i { transition: color 0.3s ease; } /* Loading spinner color set by theme */

        /* Line Clamp */
        .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }
        .line-clamp-3 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 3; }

        /* Custom Date Input Styling */
        input[type="date"] { appearance: none; -webkit-appearance: none; position: relative; background-color: white; }
        input[type="date"].custom-date-input {
            border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem 0.75rem;
            font-size: 0.875rem; line-height: 1.25rem; color: #374151;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="date"].custom-date-input:focus {
            outline: none; border-color: #4f46e5; /* Default focus color, can be themed if desired */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3); /* Default focus shadow */
        }

        input[type="date"].custom-date-input::-webkit-calendar-picker-indicator {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="%236b7280" style="width:1rem; height:1rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" /></svg>') no-repeat center;
            background-size: 1rem 1rem; cursor: pointer; opacity: 0.7; transition: opacity 0.2s ease;
        }
         input[type="date"].custom-date-input::-webkit-calendar-picker-indicator:hover { opacity: 1; }

        /* Modal Scrollbar */
        .modal-content::-webkit-scrollbar { width: 6px; }
        .modal-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb { background: #a5b4fc; border-radius: 10px; } /* Default thumb */
        .modal-content::-webkit-scrollbar-thumb:hover { background: #818cf8; }

        /* Fade In Animation */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Filter Buttons */
        .filter-button {
            transition: all 0.2s ease-in-out; padding: 0.5rem 1rem; border-radius: 9999px;
            font-size: 0.875rem; font-weight: 500; border: 1px solid transparent;
            cursor: pointer;
            white-space: nowrap; /* Prevent button text wrapping */
        }
        .filter-button.active { /* Active state colors set by theme */ }
        .filter-button:not(.active) { background-color: #e5e7eb; color: #374151; border-color: #d1d5db; }
        .filter-button:not(.active):hover { background-color: #d1d5db; border-color: #9ca3af; }

        /* Suggestion Modal Specific Styles */
        #suggest-modal .modal-content { /* No specific styles needed currently */ }

        /* Base Category Switch Button Styles */
        .category-switch-button {
            padding: 0.6rem 1.2rem; /* Slightly larger padding */
            border-radius: 9999px; /* Pill shape */
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* semibold */
            border: 1px solid rgba(255, 255, 255, 0.2); /* Subtle border */
            color: rgba(255, 255, 255, 0.7); /* Dimmer text */
            background-color: rgba(255, 255, 255, 0.05); /* Very subtle background */
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            white-space: nowrap; /* Prevent button text wrapping */
        }
        .category-switch-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: rgba(255, 255, 255, 0.4);
        }
        .category-switch-button.active {
             color: white;
             box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
             border-color: transparent;
             /* Active background color set by theme */
        }

        /* --- Theme Specific Styles --- */

        /* Default: Finance Theme (Indigo/Blue) */
        .theme-finance { background-color: #f3f4f6; } /* Light gray background */
        .theme-finance .gradient-bg { background: linear-gradient(135deg, #1f2937 0%, #111827 100%); }
        .theme-finance .gradient-accent { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
        .theme-finance .text-gradient { background: linear-gradient(to right, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .theme-finance .filter-button.active { background-color: #4f46e5; color: white; box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2); }
        .theme-finance .date-badge { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); box-shadow: 0 2px 5px rgba(79, 70, 229, 0.3); }
        .theme-finance #loading i { color: #4f46e5; }
        .theme-finance .category-switch-button.active { background-color: #4f46e5; } /* Active Finance Button */
        .theme-finance .event-card .view-details { background-color: #eef2ff; color: #4338ca; } /* Indigo light */
        .theme-finance .event-card .view-details:hover { background-color: #e0e7ff; }
        .theme-finance #modal-content .bg-indigo-50 { background-color: #eef2ff; } /* Modal details box */
        .theme-finance #modal-content .border-indigo-100 { border-color: #e0e7ff; }
        .theme-finance #modal-content .text-indigo-600 { color: #4f46e5; } /* Icon/text color in modal date box */
        .theme-finance #modal-content .text-indigo-500 { color: #6366f1; } /* Icon color in modal date box */


        /* AI Theme (Teal/Cyan) */
        .theme-ai { background-color: #f0fdfa; } /* Very light teal background */
        .theme-ai .gradient-bg { background: linear-gradient(135deg, #0f766e 0%, #115e59 100%); } /* Darker Teal */
        .theme-ai .gradient-accent { background: linear-gradient(135deg, #14b8a6 0%, #2dd4bf 100%); } /* Teal */
        .theme-ai .text-gradient { background: linear-gradient(to right, #2dd4bf, #5eead4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .theme-ai .filter-button.active { background-color: #14b8a6; color: white; box-shadow: 0 2px 4px rgba(20, 184, 166, 0.2); }
        .theme-ai .date-badge { background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); box-shadow: 0 2px 5px rgba(20, 184, 166, 0.3); }
        .theme-ai #loading i { color: #14b8a6; }
        .theme-ai .category-switch-button.active { background-color: #14b8a6; } /* Active AI Button */
        .theme-ai .event-card .view-details { background-color: #f0fdfa; color: #0f766e; } /* Teal light */
        .theme-ai .event-card .view-details:hover { background-color: #ccfbf1; }
        .theme-ai #modal-content .bg-indigo-50 { background-color: #ccfbf1; } /* Use teal light for modal details box */
        .theme-ai #modal-content .border-indigo-100 { border-color: #99f6e4; }
        .theme-ai #modal-content .text-indigo-600 { color: #0d9488; } /* Adjust icon/text colors in modal date box */
        .theme-ai #modal-content .text-indigo-500 { color: #14b8a6; } /* Adjust icon color in modal date box */

        /* Cybersecurity Theme (Purple/Pink) */
        .theme-cyber { background-color: #faf5ff; } /* Very light purple background */
        .theme-cyber .gradient-bg { background: linear-gradient(135deg, #581c87 0%, #3730a3 100%); } /* Dark Purple/Indigo */
        .theme-cyber .gradient-accent { background: linear-gradient(135deg, #a855f7 0%, #d946ef 100%); } /* Purple/Fuchsia */
        .theme-cyber .text-gradient { background: linear-gradient(to right, #c084fc, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .theme-cyber .filter-button.active { background-color: #a855f7; color: white; box-shadow: 0 2px 4px rgba(168, 85, 247, 0.2); }
        .theme-cyber .date-badge { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); box-shadow: 0 2px 5px rgba(168, 85, 247, 0.3); }
        .theme-cyber #loading i { color: #a855f7; }
        .theme-cyber .category-switch-button.active { background-color: #a855f7; } /* Active Cyber Button */
        .theme-cyber .event-card .view-details { background-color: #faf5ff; color: #7e22ce; } /* Purple light */
        .theme-cyber .event-card .view-details:hover { background-color: #f3e8ff; }
        .theme-cyber #modal-content .bg-indigo-50 { background-color: #f5f3ff; } /* Use purple light for modal details box */
        .theme-cyber #modal-content .border-indigo-100 { border-color: #e9d5ff; }
        .theme-cyber #modal-content .text-indigo-600 { color: #9333ea; } /* Adjust icon/text colors in modal date box */
        .theme-cyber #modal-content .text-indigo-500 { color: #a855f7; } /* Adjust icon color in modal date box */

        /* Ensure modal details box text/icons adapt */
         #modal-content .bg-indigo-50 .text-gray-800 { color: #1f2937; } /* Ensure main date text stays dark */

         /* Generic Info Box in Modal (Blue) - Keep consistent across themes or theme if desired */
         #modal-content .bg-blue-50 { background-color: #eff6ff; }
         #modal-content .border-blue-100 { border-color: #dbeafe; }
         #modal-content .text-blue-800 { color: #1e40af; }
         #modal-content .text-blue-700 { color: #1d4ed8; }

    </style>
</head>
<body class="theme-finance"> <input type="file" id="csv-file" accept=".csv" class="hidden"> <header class="gradient-bg text-white">
        <div class="container mx-auto px-4 py-12 md:py-20 text-center">

            <div class="mb-8 flex justify-center gap-x-3 sm:gap-x-4 flex-wrap"> <button id="finance-category-button" class="category-switch-button active">
                    <i class="fas fa-chart-line mr-1.5 sm:mr-2 text-xs sm:text-sm"></i>Finance
                </button>
                <button id="ai-category-button" class="category-switch-button">
                    <i class="fas fa-brain mr-1.5 sm:mr-2 text-xs sm:text-sm"></i>AI
                </button>
                <button id="cyber-category-button" class="category-switch-button">
                    <i class="fas fa-shield-alt mr-1.5 sm:mr-2 text-xs sm:text-sm"></i>Cybersecurity
                </button>
            </div>

            <div class="mb-4">
                <span class="headline-logo logo-text text-gradient">NoLeaf</span>
                 <p class="text-xs text-gray-400">
                    Developed by <a href="https://kamathhrishi.github.io/MyWebsite/about/" target="_blank" rel="noopener noreferrer" class="hover:text-indigo-300 transition-colors underline decoration-dotted">Hrishikesh Kamath</a>
                 </p>
            </div>

             <h1 class="mb-4 max-w-4xl mx-auto">
                 <span class="headline-description">The Most Exhaustive List of <span id="category-title-span">Finance & Investment</span> Events</span>
            </h1>
            <p class="text-lg md:text-xl text-gray-300 mb-8 max-w-3xl mx-auto">
                Explore <span id="total-event-count-display" class="font-bold text-xl text-white">1800+</span> events across the US.
            </p>

            <div class="flex flex-wrap gap-4 justify-center">
                <a href="#events-section" class="gradient-accent text-white font-medium rounded-lg px-6 py-3 inline-flex items-center transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    <i class="fas fa-calendar-alt mr-2"></i> Browse Events
                </a>
                <button id="suggest-event-button" class="bg-gray-700 hover:bg-gray-600 text-white font-medium rounded-lg px-6 py-3 inline-flex items-center transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                    <i class="fas fa-plus-circle mr-2"></i> Missing event? Let us know
                </button>
            </div>
        </div>
    </header>

    <section class="bg-white/95 backdrop-blur-sm border-b border-gray-200 shadow-sm">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row md:items-center justify-center flex-wrap gap-4">

                <div id="location-filters-container" class="flex items-center justify-center gap-2 flex-shrink-0 order-1 flex-wrap"> <button id="all-filter" data-location="all" class="filter-button active">All</button>
                    <div id="finance-location-filters" class="">
                         <button id="nyc-filter" data-location="nyc" class="filter-button">New York</button>
                         <button id="philly-filter" data-location="philly" class="filter-button">Philadelphia</button>
                    </div>
                    <div id="tech-location-filters" class="hidden">
                        <button id="sf-filter" data-location="sf" class="filter-button">SF Bay Area</button>
                        <button id="seattle-filter" data-location="seattle" class="filter-button">Seattle</button>
                        <button id="austin-filter" data-location="austin" class="filter-button">Austin</button>
                        <button id="boston-filter" data-location="boston" class="filter-button">Boston</button>
                    </div>
                </div>

                <div class="relative flex-grow md:max-w-lg w-full order-3 md:order-2">
                    <input type="text" id="search-input"
                           placeholder="Search Finance & Investment events, types..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    <i class="fas fa-search absolute left-3.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>

                <div class="flex flex-col sm:flex-row items-center justify-center sm:justify-end gap-x-3 gap-y-2 w-full md:w-auto order-2 md:order-3">
                    <label for="start-date" class="text-sm font-medium text-gray-600 flex-shrink-0 whitespace-nowrap">Date From:</label>
                    <input type="date" id="start-date" class="custom-date-input w-full sm:w-auto">
                    <label for="end-date" class="text-sm font-medium text-gray-600 ml-0 sm:ml-1 flex-shrink-0 whitespace-nowrap">To:</label>
                    <input type="date" id="end-date" class="custom-date-input w-full sm:w-auto">
                </div>
            </div>
        </div>
    </section>

    <section id="events-section" class="py-12 md:py-16">
        <div class="container mx-auto px-4">
            <div class="mb-10 md:flex justify-between items-center">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-1">Upcoming Events</h2>
                    <div id="event-count" class="text-gray-600">Loading events...</div>
                    </div>
                <div id="current-date-range" class="flex items-center text-sm text-gray-500 mt-2 md:mt-0 bg-gray-200 px-3 py-1.5 rounded-full">
                    <i class="far fa-calendar-alt mr-2 text-gray-600"></i>
                    <span id="date-range-display">All Dates</span>
                </div>
            </div>

            <div id="loading" class="loading-animate text-center py-16">
                <div class="inline-block p-8 bg-white rounded-lg shadow-md">
                    <i class="fas fa-spinner fa-spin text-5xl text-indigo-500 mb-4"></i>
                    <p class="text-gray-700 text-lg font-medium">Loading Events</p>
                    <p class="text-gray-500 text-sm mt-1">Fetching the latest event data...</p>
                </div>
            </div>

            <div id="events-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                </div>

            <div id="no-events" class="hidden text-center py-16 bg-white rounded-lg shadow-sm mt-8">
                <i class="fas fa-calendar-times text-6xl text-gray-300 mb-5"></i>
                <p id="no-events-message" class="text-gray-700 text-xl font-semibold">No events found.</p>
                <p class="text-gray-500 mt-2">Try adjusting your search terms or date filters.</p>
            </div>

            <div id="pagination-controls" class="flex justify-center items-center space-x-3 md:space-x-4 mt-10 mb-4 hidden">
                <button id="prev-page" class="bg-white hover:bg-gray-100 border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center shadow-sm disabled:shadow-none">
                    <i class="fas fa-chevron-left mr-2 text-xs"></i> Prev
                </button>
                <span id="page-info" class="text-gray-600 text-sm font-medium px-2">Page 1 of 1</span>
                <button id="next-page" class="bg-white hover:bg-gray-100 border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center shadow-sm disabled:shadow-none">
                    Next <i class="fas fa-chevron-right ml-2 text-xs"></i>
                </button>
            </div>
        </div>
    </section>

    <footer class="bg-gray-800 text-white py-12">
        <div class="container mx-auto px-4 text-center">
            <div class="mb-6">
                <div class="inline-flex items-center justify-center mb-2">
                     <span class="text-2xl font-bold logo-text text-gradient">NoLeaf</span>
                </div>
                <p class="text-gray-400 max-w-lg mx-auto text-sm">
                    Your premier destination for the most exhaustive list of professional events across the United States. Stay ahead of the curve.
                </p>
            </div>
             <div class="mt-8 pt-8 border-t border-gray-700">
                <p class="text-gray-500 text-sm">&copy; 2025 NoLeaf. All rights reserved. | <a href="#" class="hover:text-indigo-300">Privacy Policy</a></p> </div>
        </div>
    </footer>

    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden p-4 fade-in">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="p-5 md:p-6 flex justify-between items-center border-b border-gray-200 bg-gray-50">
                <h3 id="modal-title" class="text-xl md:text-2xl font-semibold text-gray-800 pr-4 leading-tight">Event Title Placeholder</h3>
                <button id="close-modal" class="text-gray-400 hover:text-red-600 transition-colors rounded-full p-1 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modal-content" class="p-5 md:p-8 overflow-y-auto modal-content flex-grow space-y-6">
                 </div>
            <div class="p-5 md:p-6 border-t border-gray-200 bg-gray-50 flex justify-end">
                <a id="modal-link" href="#" target="_blank" rel="noopener noreferrer" class="gradient-accent hover:opacity-90 text-white font-medium rounded-lg px-6 py-2.5 inline-flex items-center transition-all shadow hover:shadow-md transform hover:-translate-y-0.5">
                    View Event Website <i class="fas fa-external-link-alt ml-2 text-xs"></i>
                </a>
            </div>
        </div>
    </div>

    <div id="suggest-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden p-4 fade-in">
        <div class="bg-white rounded-xl max-w-lg w-full max-h-[90vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="p-5 md:p-6 flex justify-between items-center border-b border-gray-200 bg-gray-50">
                <h3 class="text-xl font-semibold text-gray-800 pr-4 leading-tight flex items-center">
                    <i class="fas fa-lightbulb mr-3 text-yellow-500"></i> Suggest an Event
                </h3>
                <button id="close-suggest-modal" class="text-gray-400 hover:text-red-600 transition-colors rounded-full p-1 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-5 md:p-8 overflow-y-auto modal-content flex-grow space-y-4">
                 <p class="text-gray-700 leading-relaxed">
                      Know of a great finance, AI, or cybersecurity event in the US that we missed? We'd love to hear about it!
                 </p>
                 <p class="text-gray-700 leading-relaxed">
                      Please send the event details (name, date, location, website link) to:
                 </p>
                 <div class="bg-indigo-50 border border-indigo-200 rounded-md p-3 text-center">
                      <a href="mailto:kamathhrishi@gmail.com" class="text-indigo-700 font-medium hover:text-indigo-900 hover:underline break-all">
                           <i class="fas fa-envelope mr-2"></i>kamathhrishi@gmail.com
                      </a>
                 </div>
                 <p class="text-sm text-gray-500 mt-3">
                      We'll review your suggestion and add it if it fits our criteria. Thanks for helping keep NoLeaf up-to-date!
                 </p>
            </div>
            <div class="p-4 md:p-5 border-t border-gray-200 bg-gray-50 flex justify-end">
                 <button id="suggest-modal-close-button-alt" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg px-5 py-2 transition-colors">
                      Close
                 </button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Global State ---
            let allEvents = []; // Holds raw data for the current category
            let currentFilteredEvents = []; // Holds filtered data for display
            let currentPage = 1;
            let totalPages = 1;
            let itemsPerPage = 9; // Default, adjusted dynamically
            let currentCategory = 'finance'; // Default category

            // --- Configuration ---
            const categories = {
                finance: {
                    name: 'Finance & Investment',
                    url: 'https://raw.githubusercontent.com/kamathhrishi/noleaf/main/events_finance.csv',
                    themeClass: 'theme-finance',
                    buttonId: 'finance-category-button',
                    titleText: 'Finance & Investment',
                    locationFilterSetId: 'finance-location-filters',
                    columnNames: { dateCol: "Event Date", titleCol: "Title", descCol: "Description", urlCol: "URL", locCol: "Event City" }
                },
                ai: {
                    name: 'AI',
                    url: 'https://raw.githubusercontent.com/kamathhrishi/noleaf/main/events_ai.csv',
                    themeClass: 'theme-ai',
                    buttonId: 'ai-category-button',
                    titleText: 'Artificial Intelligence',
                    locationFilterSetId: 'tech-location-filters',
                    columnNames: { dateCol: "Event Date", titleCol: "Title", descCol: "Description", urlCol: "URL", locCol: "Event City" }
                },
                cyber: {
                    name: 'Cybersecurity',
                    url: 'https://raw.githubusercontent.com/kamathhrishi/noleaf/main/events_cyber.csv',
                    themeClass: 'theme-cyber',
                    buttonId: 'cyber-category-button',
                    titleText: 'Cybersecurity',
                    locationFilterSetId: 'tech-location-filters',
                    columnNames: { dateCol: "Event Date", titleCol: "Title", descCol: "Description", urlCol: "URL", locCol: "Event City" }
                }
            };

            // --- DOM Elements ---
            const eventsContainer = document.getElementById('events-container');
            const loadingIndicator = document.getElementById('loading');
            const noEventsIndicator = document.getElementById('no-events');
            const noEventsMessage = document.getElementById('no-events-message');
            const eventCountEl = document.getElementById('event-count');
            // *** REMOVED DOM refs for total count ***
            const paginationControlsEl = document.getElementById('pagination-controls');
            const prevPageButton = document.getElementById('prev-page');
            const nextPageButton = document.getElementById('next-page');
            const pageInfoEl = document.getElementById('page-info');
            const searchInput = document.getElementById('search-input');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const dateRangeDisplay = document.getElementById('date-range-display');
            const eventModal = document.getElementById('event-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalLink = document.getElementById('modal-link');
            const closeModalButton = document.getElementById('close-modal');
            const suggestEventButton = document.getElementById('suggest-event-button');
            const suggestModal = document.getElementById('suggest-modal');
            const closeSuggestModalButton = document.getElementById('close-suggest-modal');
            const suggestModalCloseButtonAlt = document.getElementById('suggest-modal-close-button-alt');
            const categoryTitleSpan = document.getElementById('category-title-span');
            const locationFiltersContainer = document.getElementById('location-filters-container');
            const financeLocationFilters = document.getElementById('finance-location-filters');
            const techLocationFilters = document.getElementById('tech-location-filters');
            const allFilterButton = document.getElementById('all-filter');
            const locationFilterButtons = locationFiltersContainer.querySelectorAll('.filter-button:not(#all-filter)');
            const eventSchemaPlaceholder = document.getElementById('event-schema-placeholder');


            // --- Helper Functions ---

            /**
             * Formats a Date object into YYYY-MM-DD string.
             */
            function formatDateToYyyyMmDd(date) {
                if (!date || isNaN(date.getTime())) return '';
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            /**
             * Escapes HTML special characters for safe insertion into textContent or attributes.
             */
            function escapeHTML(str) {
                if (typeof str !== 'string') return str;
                return str.replace(/[<>"']/g, match => ({
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                })[match]);
            }


             /**
              * Parses a date string into a UTC Date object.
              */
             function parseDate(dateStr, eventRow = null) {
                 if (typeof dateStr !== 'string' || !dateStr) return new Date(NaN);
                 let date = new Date(NaN);
                 const trimmedDateStr = dateStr.trim();

                 // Try YYYY-MM-DD format (assumed UTC)
                 if (/^\d{4}-\d{2}-\d{2}/.test(trimmedDateStr)) {
                     date = new Date(trimmedDateStr.substring(0, 10) + 'T00:00:00Z');
                     if (!isNaN(date.getTime())) return date;
                     date = new Date(NaN);
                 }

                 // Try M/D/YYYY format (assume UTC)
                 if (/^\d{1,2}\/\d{1,2}\/\d{4}/.test(trimmedDateStr)) {
                     const datePart = trimmedDateStr.split(' ')[0];
                     const parts = datePart.split('/');
                     if (parts.length === 3) {
                          date = new Date(Date.UTC(parseInt(parts[2], 10), parseInt(parts[0], 10) - 1, parseInt(parts[1], 10)));
                          if (!isNaN(date.getTime())) return date;
                          date = new Date(NaN);
                     }
                 }

                 // Try "Month Day, Year" format
                 if (isNaN(date.getTime())) {
                     const potentialDate = new Date(trimmedDateStr + ' UTC');
                     if (!isNaN(potentialDate.getTime())) {
                         date = new Date(Date.UTC(potentialDate.getUTCFullYear(), potentialDate.getUTCMonth(), potentialDate.getUTCDate()));
                         if (!isNaN(date.getTime())) return date;
                          date = new Date(NaN);
                     }
                 }

                 // Fallback check for AI category's potential duplicate 'Event date' column
                 const currentConfig = categories[currentCategory];
                 // Only apply fallback if it's the AI category (identified by titleCol being 'Title')
                 if (isNaN(date.getTime()) && currentConfig && currentConfig.columnNames.titleCol === 'Title' && currentCategory === 'ai' && eventRow && eventRow['Event date'] && dateStr !== eventRow['Event date']) {
                      const fallbackDateStr = eventRow['Event date'];
                      const trimmedFallback = fallbackDateStr.trim();
                      if (/^\d{4}-\d{2}-\d{2}/.test(trimmedFallback)) {
                          date = new Date(trimmedFallback.substring(0, 10) + 'T00:00:00Z');
                      } else if (/^\d{1,2}\/\d{1,2}\/\d{4}/.test(trimmedFallback)) {
                           const datePart = trimmedFallback.split(' ')[0];
                           const parts = datePart.split('/');
                           if (parts.length === 3) {
                               date = new Date(Date.UTC(parseInt(parts[2], 10), parseInt(parts[0], 10) - 1, parseInt(parts[1], 10)));
                           }
                      } else {
                           const potentialFallbackDate = new Date(trimmedFallback + ' UTC');
                           if (!isNaN(potentialFallbackDate.getTime())) {
                               date = new Date(Date.UTC(potentialFallbackDate.getUTCFullYear(), potentialFallbackDate.getUTCMonth(), potentialFallbackDate.getUTCDate()));
                           }
                      }
                      if (!isNaN(date.getTime())) return date;
                      date = new Date(NaN);
                 }
                 return date;
             }


            /**
             * Formats a Date object into a long format (e.g., "Monday, April 23, 2025").
             */
            function formatDate(date) {
                if (!date || isNaN(date.getTime())) return "Invalid Date";
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' };
                try { return date.toLocaleDateString('en-US', options); }
                catch (e) { console.error("Error formatting date:", e); return "Invalid Date"; }
            }

            /**
             * Formats a Date object into a short format (e.g., "Apr 23").
             */
            function formatShortDate(date) {
                if (!date || isNaN(date.getTime())) return "N/A";
                const options = { month: 'short', day: 'numeric', timeZone: 'UTC' };
                 try { return date.toLocaleDateString('en-US', options); }
                 catch (e) { console.error("Error formatting short date:", e); return "N/A"; }
            }

            /**
             * Formats a YYYY-MM-DD date string for display (e.g., "Apr 23, 2025").
             */
            function formatDisplayDate(dateStr) {
                 if (!dateStr) return null;
                 const parts = dateStr.split('-');
                 if (parts.length !== 3) return null;
                 const year = parseInt(parts[0], 10);
                 const month = parseInt(parts[1], 10) - 1;
                 const day = parseInt(parts[2], 10);
                 const date = new Date(Date.UTC(year, month, day));
                 if (!isNaN(date.getTime())) {
                     const displayMonth = date.toLocaleString('en-US', { month: 'short', timeZone: 'UTC' });
                     const displayDay = date.getUTCDate();
                     const displayYear = date.getUTCFullYear();
                     return `${displayMonth} ${displayDay}, ${displayYear}`;
                 }
                 return null;
            }

            /**
             * Gets the UTC midnight Date object for a given Date.
             */
            function getUtcMidnight(date) {
                if (!date || isNaN(date.getTime())) return null;
                return new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
            }


            // --- Theme and UI Management ---

            /**
             * Updates the visibility of location filter sets based on the category.
             */
            function updateLocationFiltersUI(categoryKey) {
                const financeFilters = document.getElementById('finance-location-filters');
                const techFilters = document.getElementById('tech-location-filters');

                if (!financeFilters || !techFilters) {
                    console.error("Location filter containers not found!");
                    return;
                }

                financeFilters.classList.add('hidden');
                techFilters.classList.add('hidden');

                const categoryConfig = categories[categoryKey];
                if (categoryConfig) {
                    const filterSetToShow = document.getElementById(categoryConfig.locationFilterSetId);
                    if (filterSetToShow) {
                        filterSetToShow.classList.remove('hidden');
                    } else {
                        console.error(`Location filter set ID not found: ${categoryConfig.locationFilterSetId}`);
                    }
                }
                setActiveFilter(allFilterButton); // Reset to 'All' visually
            }


            /**
             * Applies the theme and updates UI elements for the selected category.
             */
            function applyTheme(categoryKey) {
                const categoryConfig = categories[categoryKey];
                if (!categoryConfig) {
                     console.error(`Invalid category key for theme: ${categoryKey}`);
                     return;
                }
                const themeClass = categoryConfig.themeClass;
                const buttonId = categoryConfig.buttonId;
                const titleText = categoryConfig.titleText; // Contains '&' directly

                console.log(`Applying theme for: ${categoryKey} (${themeClass})`);

                // 1. Update Body Class
                Object.values(categories).forEach(cat => {
                    document.body.classList.remove(cat.themeClass);
                });
                document.body.classList.add(themeClass);
                currentCategory = categoryKey;

                // 2. Update Active Category Button Visual State
                Object.values(categories).forEach(cat => {
                    const btn = document.getElementById(cat.buttonId);
                    if(btn) btn.classList.remove('active');
                });
                const activeBtn = document.getElementById(buttonId);
                if(activeBtn) activeBtn.classList.add('active');

                // 3. Update H1 Title Span (Use innerHTML to render '&' correctly)
                if (categoryTitleSpan) categoryTitleSpan.innerHTML = titleText; // Use innerHTML

                // 4. Update search placeholder (Escape for attribute safety)
                searchInput.placeholder = `Search ${escapeHTML(titleText)} events, types...`;

                 // 5. Update visible location filters
                updateLocationFiltersUI(categoryKey);
            }

            // --- Core Logic: Data Loading and Processing ---

            /**
             * Sets the default date range in the input fields.
             */
            function setDefaultDateRange() {
                const today = new Date();
                const oneMonthFromToday = new Date(today);
                oneMonthFromToday.setMonth(today.getMonth() + 1);
                const defaultStartDateStr = formatDateToYyyyMmDd(today);
                const defaultEndDateStr = formatDateToYyyyMmDd(oneMonthFromToday);
                if (startDateInput) startDateInput.value = defaultStartDateStr;
                if (endDateInput) endDateInput.value = defaultEndDateStr;
                updateDateRangeDisplay();
            }

            /**
             * Loads and parses event data from a CSV URL for the current category view.
             */
            function loadFromCSV(csvUrl) {
                console.log(`Loading CSV for category '${currentCategory}' from:`, csvUrl);
                loadingIndicator.style.display = 'block';
                eventsContainer.innerHTML = '';
                noEventsIndicator.classList.add('hidden');
                paginationControlsEl.classList.add('hidden');
                eventCountEl.innerHTML = `Loading ${categories[currentCategory]?.name || ''} events...`; // Use innerHTML
                allEvents = [];
                currentFilteredEvents = [];
                currentPage = 1;

                Papa.parse(csvUrl, {
                    download: true, header: true, skipEmptyLines: true,
                    complete: handleParsedData,
                    error: (err) => {
                         console.error(`CSV Error for ${csvUrl}:`, err);
                         handleCSVError(`Could not fetch or parse ${categories[currentCategory]?.name || 'event'} data.`); // Use innerHTML in handleCSVError
                    }
                });
            }

            /**
             * Handles the parsed CSV data for the current category.
             */
            function handleParsedData(results) {
                try {
                    loadingIndicator.style.display = 'none';
                    if (results.data && results.data.length > 0) {
                        const categoryConfig = categories[currentCategory];
                        if (!categoryConfig || !categoryConfig.columnNames) {
                            console.error("Missing category configuration for:", currentCategory);
                            handleCSVError(`Configuration error for ${currentCategory}.`);
                            return;
                        }
                        const columnNames = categoryConfig.columnNames;
                        allEvents = processEvents(results.data, columnNames);
                        currentFilteredEvents = [...allEvents];
                        currentPage = 1;
                        applyFiltersAndDisplay();

                    } else if (results.errors && results.errors.length > 0) {
                        console.error("CSV Parsing Errors:", results.errors);
                        handleCSVError(`Error parsing ${categories[currentCategory]?.name || 'event'} data.`);
                    } else {
                        showNoEventsMessage(`No ${categories[currentCategory]?.name || 'event'} data found in the source file.`);
                        updateEventCount(0);
                    }
                } catch (error) {
                    console.error("Error in handleParsedData:", error);
                    handleCSVError(`Error processing ${categories[currentCategory]?.name || 'event'} data.`);
                }
            }

            /**
             * Handles errors during CSV fetching or parsing for the current view.
             */
            function handleCSVError(message = `Could not load ${categories[currentCategory]?.name || 'event'} data.`) {
                loadingIndicator.style.display = 'none';
                showNoEventsMessage(message); // Message might contain category name with '&', so showNoEventsMessage uses innerHTML
                updateEventCount(0);
                paginationControlsEl.classList.add('hidden');
                allEvents = [];
                currentFilteredEvents = [];
            }

            /**
             * Processes raw event data from the CSV.
             */
            function processEvents(data, columnNames) {
                console.log("Processing raw data rows:", data.length);
                if (!(data.length > 0 && data[0])) return [];

                const dateCol = columnNames.dateCol;
                const titleCol = columnNames.titleCol;
                const descCol = columnNames.descCol;
                const urlCol = columnNames.urlCol;
                const locCol = columnNames.locCol;

                let skippedDateCount = 0;
                let skippedUrlCount = 0;

                const processed = data
                    .map((event, index) => {
                        let eventDate = parseDate(event[dateCol], event);
                        if (isNaN(eventDate.getTime())) {
                             skippedDateCount++;
                             return null;
                        }
                        const url = String(event[urlCol] || '').trim();
                        if (!url || url === '#') {
                             skippedUrlCount++;
                             return null;
                        }
                        return {
                            title: String(event[titleCol] || 'Untitled Event').trim(),
                            description: String(event[descCol] || 'No description available.').trim(),
                            url: url,
                            date: eventDate,
                            formattedDate: formatDate(eventDate),
                            shortDate: formatShortDate(eventDate),
                            location: String(event[locCol] || 'Location TBD').trim(),
                            month: eventDate.toLocaleString('default', { month: 'short', timeZone: 'UTC' }),
                            day: eventDate.getUTCDate()
                        };
                    })
                    .filter(event => event !== null)
                    .sort((a, b) => a.date - b.date);

                if (skippedDateCount > 0 || skippedUrlCount > 0) {
                    console.log(`Finished processing ${currentCategory}. Skipped ${skippedDateCount} dates, ${skippedUrlCount} URLs.`);
                }
                console.log(`Valid events after processing ${currentCategory}:`, processed.length);
                return processed;
            }

            // --- *** REMOVED loadAllEventCounts function *** ---


            // --- Core Logic: Display and UI Updates ---

            /**
             * Displays the events for the current page.
             */
            function displayCurrentPage() {
                 eventsContainer.innerHTML = '';
                 noEventsIndicator.classList.add('hidden');

                 const screenWidth = window.innerWidth;
                 if (screenWidth < 640) { itemsPerPage = 4; }
                 else if (screenWidth < 1024) { itemsPerPage = 8; }
                 else { itemsPerPage = 9; }

                 totalPages = Math.max(1, Math.ceil(currentFilteredEvents.length / itemsPerPage));
                 currentPage = Math.max(1, Math.min(currentPage, totalPages));

                 const startIndex = (currentPage - 1) * itemsPerPage;
                 const endIndex = startIndex + itemsPerPage;
                 const paginatedItems = currentFilteredEvents.slice(startIndex, endIndex);

                 console.log(`Displaying page ${currentPage}/${totalPages}. Items ${startIndex}-${endIndex - 1} (PerPage: ${itemsPerPage}) for ${currentCategory}`);

                 if (currentFilteredEvents.length === 0) {
                     showNoEventsMessage(); // Uses default message which includes category name
                     paginationControlsEl.classList.add('hidden');
                 } else if (paginatedItems.length === 0 && currentPage > 1) {
                     currentPage--;
                     displayCurrentPage();
                 } else {
                     paginatedItems.forEach(event => {
                         if (!event) return;
                         let locationBadgeClass = 'generic-badge';
                         const locLower = event.location.toLowerCase();
                         if (locLower.includes('new york') || locLower.includes('nyc')) locationBadgeClass = 'nyc-badge';
                         else if (locLower.includes('philadelphia') || locLower.includes('philly')) locationBadgeClass = 'philly-badge';

                         const card = document.createElement('div');
                         card.className = 'event-card relative fade-in';
                         // Use escapeHTML for data attributes and textContent
                         card.innerHTML = `
                             <div class="date-badge z-10">
                                 <span class="day">${escapeHTML(String(event.day))}</span>
                                 <span class="month">${escapeHTML(event.month)}</span>
                             </div>
                             <div class="event-card-content pt-12">
                                 <span class="location-badge ${locationBadgeClass}"><i class="fas fa-map-marker-alt mr-1.5 text-xs"></i>${escapeHTML(event.location)}</span>
                                 <h3 class="text-lg font-semibold text-gray-800 mb-2 line-clamp-2 hover:text-indigo-600 transition-colors" title="${escapeHTML(event.title)}">
                                     ${escapeHTML(event.title)}
                                 </h3>
                                 <p class="text-sm text-gray-600 mb-4 line-clamp-3 flex-grow">${escapeHTML(event.description)}</p>
                                 <div class="text-xs text-gray-500 mb-4 flex items-center">
                                     <i class="far fa-calendar-alt mr-1.5"></i> ${escapeHTML(event.formattedDate)}
                                 </div>
                                 <div class="event-card-footer">
                                     <button class="view-details w-full text-center bg-indigo-50 hover:bg-indigo-100 text-indigo-700 text-sm font-medium py-2 px-4 rounded-md transition-colors duration-150 flex items-center justify-center"
                                             data-title="${escapeHTML(event.title)}" data-date="${escapeHTML(event.formattedDate)}"
                                             data-description="${escapeHTML(event.description)}" data-location="${escapeHTML(event.location)}"
                                             data-url="${escapeHTML(event.url)}" data-month="${escapeHTML(event.month)}"
                                             data-day="${escapeHTML(String(event.day))}"
                                             data-start-date-iso="${escapeHTML(formatDateToYyyyMmDd(event.date))}">
                                         View Details <i class="fas fa-arrow-right ml-2 text-xs"></i>
                                     </button>
                                 </div>
                             </div>`;
                         eventsContainer.appendChild(card);
                     });
                     addDetailButtonListeners();
                     updatePaginationControls();
                     paginationControlsEl.classList.remove('hidden');
                 }
            }

            /**
             * Adds click event listeners to "View Details" buttons.
             */
            function addDetailButtonListeners() {
                const oldButtons = eventsContainer.querySelectorAll('.view-details');
                oldButtons.forEach(button => {
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);
                });
                eventsContainer.querySelectorAll('.view-details').forEach(button => {
                    button.addEventListener('click', function() {
                        const eventData = {
                            title: this.dataset.title, date: this.dataset.date, description: this.dataset.description,
                            location: this.dataset.location, url: this.dataset.url, month: this.dataset.month, day: this.dataset.day,
                            startDateIso: this.dataset.startDateIso
                        };
                        showEventDetails(eventData);
                    });
                });
            }

            /**
             * Updates the text indicating the number of events matching the current filters.
             */
            function updateEventCount(count) {
                 if (eventCountEl) {
                     const categoryName = categories[currentCategory]?.name || 'event';
                     // Use innerHTML here because categoryName might contain '&'
                     eventCountEl.innerHTML = `Showing ${count.toLocaleString()} ${categoryName} event${count !== 1 ? 's' : ''} matching filters`;
                 }
            }


            /**
             * Shows the "No Events Found" message.
             */
            function showNoEventsMessage(message = `No ${categories[currentCategory]?.name || 'events'} match your current criteria.`) {
                 if (noEventsIndicator && noEventsMessage) {
                     // Use innerHTML here as the default message uses categoryName which might have '&'
                     noEventsMessage.innerHTML = message;
                     noEventsIndicator.classList.remove('hidden');
                 }
                 eventsContainer.innerHTML = '';
                 paginationControlsEl.classList.add('hidden');
            }

            /**
             * Updates the pagination controls.
             */
            function updatePaginationControls() {
                 if (!pageInfoEl || !prevPageButton || !nextPageButton) return;
                 pageInfoEl.textContent = `Page ${currentPage} of ${totalPages}`;
                 prevPageButton.disabled = (currentPage === 1);
                 prevPageButton.classList.toggle('disabled:opacity-50', prevPageButton.disabled);
                 prevPageButton.classList.toggle('disabled:cursor-not-allowed', prevPageButton.disabled);
                 prevPageButton.classList.toggle('disabled:shadow-none', prevPageButton.disabled);
                 nextPageButton.disabled = (currentPage >= totalPages);
                 nextPageButton.classList.toggle('disabled:opacity-50', nextPageButton.disabled);
                 nextPageButton.classList.toggle('disabled:cursor-not-allowed', nextPageButton.disabled);
                 nextPageButton.classList.toggle('disabled:shadow-none', nextPageButton.disabled);
            }

            /**
             * Updates the display showing the selected date range.
             */
            function updateDateRangeDisplay() {
                 if (!dateRangeDisplay) return;
                 const startDateVal = startDateInput?.value;
                 const endDateVal = endDateInput?.value;
                 let text = 'All Dates';
                 try {
                     const start = startDateVal ? formatDisplayDate(startDateVal) : null;
                     const end = endDateVal ? formatDisplayDate(endDateVal) : null;
                     if (start && end) text = `From ${start} to ${end}`;
                     else if (start) text = `From ${start}`;
                     else if (end) text = `Until ${end}`;
                 } catch (e) {
                     console.error("Error formatting date range for display:", e);
                     text = "Invalid Date Range";
                 }
                 dateRangeDisplay.textContent = text;
            }

            /**
             * Populates and shows the event details modal.
             */
            function showEventDetails(eventData) {
                 if (!eventData) return;
                 const title = eventData.title || 'Event Details';
                 const description = eventData.description || 'No description available.';
                 const location = eventData.location || 'Location TBD';
                 const formattedDate = eventData.date || 'Date TBD';
                 const url = eventData.url;
                 const monthShort = eventData.month || '?';
                 const dayOfMonth = eventData.day || '?';
                 const startDateIso = eventData.startDateIso;

                 modalTitle.textContent = escapeHTML(title); // Use textContent for safety
                 // Use escapeHTML for potentially user-influenced data
                 modalContent.innerHTML = `
                     <div class="space-y-5">
                         <div class="bg-indigo-50 rounded-lg p-4 flex items-start border border-indigo-100">
                             <div class="mr-5 flex-shrink-0">
                                 <div class="bg-white rounded-lg shadow p-3 text-center w-16 border border-gray-200">
                                     <div class="text-xs text-indigo-600 uppercase font-semibold tracking-wide">${escapeHTML(monthShort)}</div>
                                     <div class="text-3xl font-bold text-gray-800 mt-1">${escapeHTML(String(dayOfMonth))}</div>
                                 </div>
                             </div>
                             <div class="flex-grow mt-1">
                                 <div class="text-sm text-gray-600 mb-1 font-medium">${escapeHTML(formattedDate)}</div>
                                 <div class="flex items-center text-gray-700">
                                     <i class="fas fa-map-marker-alt mr-2 text-indigo-500 fa-fw"></i>
                                     <span class="font-medium">${escapeHTML(location)}</span>
                                 </div>
                             </div>
                         </div>
                         <div>
                             <h4 class="text-lg font-semibold text-gray-800 mb-2">About This Event</h4>
                             <p class="text-gray-700 leading-relaxed whitespace-pre-wrap">${escapeHTML(description)}</p>
                         </div>
                         <div class="bg-blue-50 rounded-lg p-4 border border-blue-100">
                             <div class="flex items-center text-blue-800">
                                 <i class="fas fa-info-circle mr-2 fa-fw"></i>
                                 <span class="font-medium text-sm">Event Information</span>
                             </div>
                              <p class="text-blue-700 text-sm mt-1.5">This is a ${categories[currentCategory]?.name || 'curated'} event listed by NoLeaf.</p>
                         </div>
                     </div>`;
                 modalLink.href = url; // URL is assumed safe from config/CSV
                 modalLink.classList.remove('opacity-50', 'cursor-not-allowed');
                 modalLink.setAttribute('target', '_blank');

                 // --- Add Event JSON-LD Schema ---
                 if (eventSchemaPlaceholder && startDateIso) {
                     try {
                         const eventSchema = {
                             "@context": "https://schema.org", "@type": "Event",
                             "name": title, "startDate": startDateIso, "description": description, "url": url,
                             "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
                             "eventStatus": "https://schema.org/EventScheduled",
                             "location": { "@type": "Place", "name": location, "address": location }
                         };
                         eventSchemaPlaceholder.textContent = JSON.stringify(eventSchema, null, 2);
                         console.log("Added Event Schema:", eventSchema);
                     } catch (e) {
                          console.error("Error generating event schema:", e);
                          eventSchemaPlaceholder.textContent = '';
                     }
                 } else {
                      eventSchemaPlaceholder.textContent = '';
                 }
                 // --- End Schema ---

                 eventModal.classList.remove('hidden');
                 closeModalButton.focus();
            }

            /**
             * Clears the event schema when the modal is closed.
             */
            function clearEventSchema() {
                 if (eventSchemaPlaceholder) eventSchemaPlaceholder.textContent = '';
            }

            // --- Filtering Logic ---

            /**
             * Sets the visual active state for the location filter buttons.
             */
            function setActiveFilter(activeButton) {
                 locationFiltersContainer.querySelectorAll('.filter-button').forEach(button => button.classList.remove('active'));
                 if (activeButton) activeButton.classList.add('active');
                 else if (allFilterButton) allFilterButton.classList.add('active');
            }

            /**
             * Filters events based on current criteria and updates display.
             */
            function applyFiltersAndDisplay() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const activeFilterButton = locationFiltersContainer.querySelector('.filter-button.active');
                const currentLocationFilter = activeFilterButton ? activeFilterButton.dataset.location : 'all';
                const startDateVal = startDateInput?.value;
                const endDateVal = endDateInput?.value;
                const startDate = startDateVal ? getUtcMidnight(parseDate(startDateVal)) : null;
                const endDate = endDateVal ? getUtcMidnight(parseDate(endDateVal)) : null;

                console.log(`Filtering ${currentCategory} with StartDate:`, startDate, "EndDate:", endDate, "Location:", currentLocationFilter, "Search:", searchTerm);

                currentFilteredEvents = allEvents.filter(event => {
                     if (!event || !event.date || isNaN(event.date.getTime())) return false;
                     const title = event.title || '';
                     const description = event.description || '';
                     const location = event.location || '';

                     const searchMatch = searchTerm === '' ||
                                       title.toLowerCase().includes(searchTerm) ||
                                       description.toLowerCase().includes(searchTerm) ||
                                       location.toLowerCase().includes(searchTerm);

                    let locationFilterMatch = true;
                    if (currentLocationFilter !== 'all') {
                        const locLower = location.toLowerCase();
                        switch (currentLocationFilter) {
                            case 'nyc': locationFilterMatch = locLower.includes('new york') || locLower.includes('nyc'); break;
                            case 'philly': locationFilterMatch = locLower.includes('philadelphia') || locLower.includes('philly'); break;
                            case 'sf': locationFilterMatch = locLower.includes('san francisco') || locLower.includes('bay area') || locLower.includes('palo alto') || locLower.includes('mountain view') || locLower.includes('san jose') || locLower.includes('menlo park') || locLower.includes('santa clara'); break;
                            case 'seattle': locationFilterMatch = locLower.includes('seattle') || locLower.includes('redmond') || locLower.includes('bellevue'); break;
                            case 'austin': locationFilterMatch = locLower.includes('austin'); break;
                            case 'boston': locationFilterMatch = locLower.includes('boston') || locLower.includes('cambridge'); break;
                            default: locationFilterMatch = false;
                        }
                    }

                     const eventDateUtc = getUtcMidnight(event.date);
                     let dateFilterMatch = true;
                     if (eventDateUtc) {
                         const startMatch = !startDate || (eventDateUtc >= startDate);
                         const endMatch = !endDate || (eventDateUtc <= endDate);
                         dateFilterMatch = startMatch && endMatch;
                     } else { dateFilterMatch = false; }

                     return searchMatch && locationFilterMatch && dateFilterMatch;
                 });

                 currentPage = 1;
                 displayCurrentPage();
                 updateEventCount(currentFilteredEvents.length);
                 updateDateRangeDisplay();
            }


            // --- Event Listeners Setup ---

            /**
             * Sets up category switcher listeners.
             */
            function setupCategorySwitchers() {
                Object.keys(categories).forEach(key => {
                    const button = document.getElementById(categories[key].buttonId);
                    if (button) {
                        button.addEventListener('click', () => {
                            if (currentCategory !== key) {
                                console.log(`Switching to category: ${key}`);
                                applyTheme(key);
                                searchInput.value = '';
                                updateDateRangeDisplay();
                                loadFromCSV(categories[key].url);
                            }
                        });
                    } else { console.error(`Category button not found: ${categories[key].buttonId}`); }
                });
            }

             /**
              * Sets up location filter listeners.
              */
             function setupLocationFilters() {
                  locationFiltersContainer.querySelectorAll('.filter-button').forEach(button => {
                       button.addEventListener('click', function() {
                           setActiveFilter(this);
                           applyFiltersAndDisplay();
                       });
                  });
             }

            // --- Initialize Event Listeners ---

            searchInput.addEventListener('input', applyFiltersAndDisplay);
            if (startDateInput) startDateInput.addEventListener('change', applyFiltersAndDisplay);
            if (endDateInput) endDateInput.addEventListener('change', applyFiltersAndDisplay);

            prevPageButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--; displayCurrentPage();
                    window.scrollTo({ top: eventsContainer.offsetTop - 80, behavior: 'smooth' });
                }
            });
            nextPageButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++; displayCurrentPage();
                    window.scrollTo({ top: eventsContainer.offsetTop - 80, behavior: 'smooth' });
                }
            });

            closeModalButton.addEventListener('click', () => { eventModal.classList.add('hidden'); clearEventSchema(); });
            eventModal.addEventListener('click', (event) => { if (event.target === eventModal) { eventModal.classList.add('hidden'); clearEventSchema(); } });

            if (suggestEventButton && suggestModal && closeSuggestModalButton && suggestModalCloseButtonAlt) {
                suggestEventButton.addEventListener('click', () => { suggestModal.classList.remove('hidden'); closeSuggestModalButton.focus(); });
                closeSuggestModalButton.addEventListener('click', () => { suggestModal.classList.add('hidden'); });
                suggestModalCloseButtonAlt.addEventListener('click', () => { suggestModal.classList.add('hidden'); });
                suggestModal.addEventListener('click', (event) => { if (event.target === suggestModal) suggestModal.classList.add('hidden'); });
            } else { console.error("Suggest Event modal elements not found."); }

             window.addEventListener('keydown', (event) => {
                  if (event.key === 'Escape') {
                      if (!eventModal.classList.contains('hidden')) { eventModal.classList.add('hidden'); clearEventSchema(); }
                      if (!suggestModal.classList.contains('hidden')) suggestModal.classList.add('hidden');
                  }
             });

             let resizeTimeout;
             window.addEventListener('resize', () => {
                  clearTimeout(resizeTimeout);
                  resizeTimeout = setTimeout(() => {
                      console.log("Window resized, adjusting items per page and re-displaying.");
                      displayCurrentPage();
                  }, 250);
             });

            // --- Initial Page Load ---
            console.log("Initializing page...");
            applyTheme(currentCategory); // Apply default theme & UI
            setDefaultDateRange();       // Set default dates
            setupCategorySwitchers();    // Setup category buttons
            setupLocationFilters();      // Setup location filter buttons
            // *** REMOVED call to load total count ***
            loadFromCSV(categories[currentCategory].url); // Load initial category data

        }); // End of DOMContentLoaded
    </script>
</body>
</html>
